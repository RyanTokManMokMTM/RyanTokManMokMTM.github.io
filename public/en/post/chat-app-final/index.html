<!DOCTYPE HTML>
<html lang="en" dir="zh">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" /> 
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests" />
  <link rel="stylesheet" href="/css/APlayer.min.css">
  <link href='/css/pio.css' rel='stylesheet' type='text/css'/>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script>
  
  <title> [Development Diary] Real Time Communication APP(IV) - Final - Jackson.tmm </title>
  
  <meta name="keywords" content="Blogger, Enginner, Programmer, Learning, Note, Tech, Backend, Life">
  
  
  <meta name="author" content="jackson.tmm">
  
  <meta property="og:title" content="[Development Diary] Real Time Communication APP(IV) - Final"/>
  <meta property="og:site_name" content="Jackson.tmm">
  <meta property="og:image" content="/images/favicon.png"> 
  <meta name="title" content="[Development Diary] Real Time Communication APP(IV) - Final - Jackson.tmm" />
  
  <meta name="description" content="Welcome to Jackson.tmm&#39;s blogger! Here will share anything that interests me, but it will focus on Tech/Note/Learning.">
   
  <link rel="shortcut icon" href="/images/favicon.png" />
  <link rel="apple-touch-icon" href="/images/avatar.jpg" />
  <link rel="apple-touch-icon-precomposed" href="/images/favicon.png" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.2/css/font-awesome.min.css" rel="stylesheet" type="text/css" />
  
  <link href="//cdn.bootcdn.net/ajax/libs/imageviewer/0.1.0/viewer.min.css" rel="stylesheet"/>
  
  <link href="/css/main.css" rel="stylesheet" type="text/css" />
  <link href="/css/syntax.css" rel="stylesheet" type="text/css" />    
  
  
  
  <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js">
  </script> <script>mermaid.initialize({ startOnLoad: true, securityLevel: 'loose'});</script>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">
  <div class="container one-collumn sidebar-position-left page-home  ">
    
    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-brand-container">
<div class="site-nav-toggle">
  <div class="toggle" role="button" style="opacity: 1; top: 0px;">
      <span class="toggle-line"></span>
      <span class="toggle-line"></span>
      <span class="toggle-line"></span>
  </div>
</div>
<div class="site-meta ">
  <div class="multi-lang-switch"> 
    <i class="fa fa-fw fa-language" style="margin-right: 5px;"></i>
    
    
    
    
        
        
                          
              
                <a class="lang-link" id="zh-tw" href="http://localhost:1313/post/chat-app-final/">中文</a>
              
               
              <span class="lang-line"> / </span> 
              
            
        
            
        
    
        
        
            
        
                          
              
                 <a class="lang-link" id="en" href="#">En</a>
              
              
            
        
    
  </div>
  <div class="custom-logo-site-title">
    <a href="/en/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Jackson.tmm</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">Having a happy life every single day</p>
</div>

<div class="site-nav-right">
    <div class="toggle popup-trigger" style="opacity: 1; top: 0px;">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>

<nav class="site-nav" id="container">
    <ul id="menu" class="menu">
      
      
      
      
        <li class="menu-item ">
          <a href="/en/" rel="section" >
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />Home
          </a>
        </li>
      
      
      
        <li class="menu-item ">
          <a href="/en/about.html" rel="section" >
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />About
          </a>
        </li>
      
      
      
        <li class="menu-item ">
          <a href="/en/post" rel="section" >
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />Posts
          </a>
        </li>
      
      
      
        <li class="menu-item ">
          <a href="/en/leetcodes" rel="section" >
              <i class="menu-item-icon fa fa-fw fa-code"></i> <br />Leetcodes 
          </a>
        </li>
      
      
      
        <li class="menu-item ">
          <a href="/en/project" rel="section" >
              <i class="menu-item-icon fa fa-fw fa-tasks"></i> <br />Projects
          </a>
        </li>
      
      
      
        <li class="menu-item ">
          <a href="/en/achievement" rel="section" >
              <i class="menu-item-icon fa fa-fw fa-trophy"></i> <br />achievement
          </a>
        </li>
      
      <li class="menu-item menu-item-search">
        <a href="javascript:;" class="popup-trigger"> <i class="menu-item-icon fa fa-search fa-fw"></i> <br /> Search</a>
      </li>
    </ul>
    
    <div class="site-search">
      <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon"><i class="fa fa-search"></i> </span>
    <span class="popup-btn-close"><i class="fa fa-times-circle"></i></span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="Enter key words..." spellcheck="false" type="text" id="local-search-input" autocapitalize="none" autocorrect="off">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>

    </div>
</nav>
 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
<section id="posts" class="posts-expand">
  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">
      
      <h1 class="post-title" itemprop="name headline">
        <a class="post-title-link" href="http://localhost:1313/en/post/chat-app-final/" itemprop="url">
        [Development Diary] Real Time Communication APP(IV) - Final
        </a>
      </h1>
      
      <div class="post-meta">
      <span class="post-time">
<i class="fa fa-calendar-o fa-fw"></i>
<span class="post-meta-item-text">Published at:</span>
<time itemprop="dateCreated" datetime="2016-03-22T13:04:35+08:00" content="2023-05-01">
    2023-05-01
</time>
</span> 
      

  <span class="post-category" >
  &nbsp; | &nbsp;
  
  <i class="fa fa-folder-o fa-fw"></i>
  
  <span class="post-meta-item-text">Categories:</span>
  
    <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
      <a href="/en/categories/dev-diary" itemprop="url" rel="index" style="text-decoration: underline">
        <span itemprop="name">dev-diary</span>
      </a>
      &nbsp; 
    </span>
  
    <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
      <a href="/en/categories/side-project" itemprop="url" rel="index" style="text-decoration: underline">
        <span itemprop="name">side-project</span>
      </a>
      &nbsp; 
    </span>
  
</span>


       <span>
 | 
<i class="fa fa-file-word-o fa-fw"></i>
<span class="post-meta-item-text">Words:</span>
<span class="leancloud-world-count">1687 words</span>
</span>
       <span>
 | 
<i class="fa fa-eye fa-fw"></i>
<span class="post-meta-item-text">Reading:</span>
<span class="leancloud-view-count">4 minutes</span>
</span>
      <span id="/en/post/chat-app-final/" class="leancloud_visitors" data-flag-title="[Development Diary] Real Time Communication APP(IV) - Final">
 | 
<i class="fa fa-binoculars fa-fw"></i>
<span class="post-meta-item-text">Visited:</span>
<span class="leancloud-visitors-count"></span>
</span>
      </div>
     
    </header>
  
    <div class="post-body" itemprop="articleBody">
    <h3 id="簡介">簡介</h3>
<p>Previous <a href="/en/post/chat-app-init/">article</a>, I has discussed about the app. You can read more from it.</p>
<p>In this article, I&rsquo;ll show what have I done in this final version, perhaps there may have some feature not yet implemented xD. Before I jump into today&rsquo;s topic, let me repeat what features will be included.</p>
<p>This application focuses on Websocket, which is used to implement real-time communication. The server-side has implemented HTTP and Websocket; HTTP is for CRUD, and Websocket is for communication.</p>
<h3 id="tech-stack">Tech Stack</h3>
<ul>
<li>SwiftUI</li>
<li>Golang</li>
<li>Go-Zero</li>
<li>Gorm</li>
<li>Mysql</li>
<li>Redis</li>
<li>Docker/Docker-compose</li>
</ul>
<h3 id="features-">Features ：</h3>
<ul>
<li>Basic：
<ul>
<li>User login and registration</li>
<li>User profile modification, including user avatar, name, and status message</li>
<li>Retrieve user information</li>
<li>Search for friends (by name)</li>
<li>Add/Delete friends</li>
<li>Retrieve friend list</li>
<li>Create a group, where you can select friends to invite, and they will be added to the group upon creation.</li>
<li>Search for groups (by group name)</li>
<li>Join unjoined groups/leave joined groups</li>
<li>Modify group information (group permissions), including changing the group avatar and group name</li>
<li>Retrieve group member list</li>
<li>Retrieve list of joined groups</li>
</ul>
</li>
<li>Extra:
<ul>
<li>Add user stories (24 hours)</li>
<li>Retrieve user friend stories</li>
<li>Retrieve specific stories</li>
<li>Delete specific stories</li>
<li>Reply to a specific friend&rsquo;s story - send a message to the story user via WebSocket</li>
</ul>
</li>
<li>Core
<ul>
<li>One-on-one chat - send messages via WebSocket</li>
<li>Group chat - send messages via WebSocket</li>
<li>All chat rooms support the following message types:</li>
</ul>
<ol>
<li>Text</li>
<li>Images (e.g., jpg, png)</li>
<li>Files (e.g., pdf, docx, txt, ppt, etc.)</li>
<li>Audio (e.g., wav, mp3)</li>
<li>Video (currently only supports mp4)</li>
</ol>
</li>
</ul>
<h3 id="apis---crud">APIs - CRUD</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript3" data-lang="gdscript3"><span style="display:flex;"><span>User API
</span></span><span style="display:flex;"><span><span style="color:#666">-</span> POST <span style="color:#666">/</span>api<span style="color:#666">/</span>v1<span style="color:#666">/</span>user<span style="color:#666">/</span>signup
</span></span><span style="display:flex;"><span><span style="color:#666">-</span> POST <span style="color:#666">/</span>api<span style="color:#666">/</span>v1<span style="color:#666">/</span>user<span style="color:#666">/</span>signin
</span></span><span style="display:flex;"><span><span style="color:#666">-</span> GET <span style="color:#666">/</span>api<span style="color:#666">/</span>v1<span style="color:#666">/</span>user<span style="color:#666">/</span>info
</span></span><span style="display:flex;"><span><span style="color:#666">-</span> GET <span style="color:#666">/</span>api<span style="color:#666">/</span>v1<span style="color:#666">/</span>user<span style="color:#666">/</span>profile 
</span></span><span style="display:flex;"><span><span style="color:#666">-</span> PATCH <span style="color:#666">/</span>api<span style="color:#666">/</span>v1<span style="color:#666">/</span>user<span style="color:#666">/</span>info
</span></span><span style="display:flex;"><span><span style="color:#666">-</span> PATCH <span style="color:#666">/</span>api<span style="color:#666">/</span>v1<span style="color:#666">/</span>UpdateUserStatus
</span></span><span style="display:flex;"><span><span style="color:#666">-</span> POST <span style="color:#666">/</span>api<span style="color:#666">/</span>v1<span style="color:#666">/</span>UploadUserAvatar 
</span></span><span style="display:flex;"><span><span style="color:#666">-</span> POST <span style="color:#666">/</span>api<span style="color:#666">/</span>v1<span style="color:#666">/</span>UploadUserCover 
</span></span><span style="display:flex;"><span><span style="color:#666">-</span> GET <span style="color:#666">/</span>api<span style="color:#666">/</span>v1<span style="color:#666">/</span>user<span style="color:#666">/</span>search 
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>Group API
</span></span><span style="display:flex;"><span>- POST /api/v1/group 
</span></span><span style="display:flex;"><span>- POST /api/v1/group/join/:group_id 
</span></span><span style="display:flex;"><span>- DELTE /api/v1/group/leave/:group_id 
</span></span><span style="display:flex;"><span>- GET /api/v1/group 
</span></span><span style="display:flex;"><span>- GET /api/v1/group/members/:group_id 
</span></span><span style="display:flex;"><span>- POST /api/v1/group/avatar/:group_id 
</span></span><span style="display:flex;"><span>- PATCH /api/v1/group 
</span></span><span style="display:flex;"><span>- GET /api/v1/group/search 
</span></span><span style="display:flex;"><span>- GET /api/v1/group/info/uuid/:uuid 
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>Friend API
</span></span><span style="display:flex;"><span>- POST /api/v1/user/friend 
</span></span><span style="display:flex;"><span>- DELETE /api/v1/user/friend 
</span></span><span style="display:flex;"><span>- GET /api/v1/user/friends
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>Story API
</span></span><span style="display:flex;"><span>- POST /api/v1/story 
</span></span><span style="display:flex;"><span>- DELETE /api/v1/story 
</span></span><span style="display:flex;"><span>- GET /api/v1/stories 
</span></span><span style="display:flex;"><span>- GET /api/v1/stories/active
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>Message API
</span></span><span style="display:flex;"><span>- GET /api/v1/message 
</span></span><span style="display:flex;"><span>- DELETE /api/v1/message =
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-gdscript3" data-lang="gdscript3"><span style="display:flex;"><span><span style="color:#d2413a;font-weight:bold">File</span> API
</span></span><span style="display:flex;"><span><span style="color:#666">-</span> POST <span style="color:#666">/</span>api<span style="color:#666">/</span>v1<span style="color:#666">/</span>file<span style="color:#666">/</span>image<span style="color:#666">/</span>upload
</span></span><span style="display:flex;"><span><span style="color:#666">-</span> POST <span style="color:#666">/</span>api<span style="color:#666">/</span>v1<span style="color:#666">/</span>file<span style="color:#666">/</span>upload 
</span></span></code></pre></div><p>Core - Websocket
Because of communication between client and server, we need to define a meaningful format for the frontend and backend to communicate.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-protobuf" data-lang="protobuf"><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">message</span> <span style="color:#00f">Message</span> {<span style="">
</span></span></span><span style="display:flex;"><span><span style=""></span>  <span style="color:#0b0;font-weight:bold">string</span> avatar <span style="color:#666">=</span> <span style="color:#666">1</span>; <span style="color:#080;font-style:italic">//user avatar path
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>  <span style="color:#0b0;font-weight:bold">string</span> fromUserName <span style="color:#666">=</span> <span style="color:#666">2</span>; <span style="color:#080;font-style:italic">//sender user name
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>  <span style="color:#0b0;font-weight:bold">string</span> fromUUID <span style="color:#666">=</span> <span style="color:#666">3</span>; <span style="color:#080;font-style:italic">//sender uuid
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>  <span style="color:#0b0;font-weight:bold">string</span> toUUID <span style="color:#666">=</span> <span style="color:#666">4</span>; <span style="color:#080;font-style:italic">//receiver uuid
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>  <span style="color:#0b0;font-weight:bold">string</span> content <span style="color:#666">=</span> <span style="color:#666">5</span>; <span style="color:#080;font-style:italic">//sending content
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>  <span style="color:#0b0;font-weight:bold">int32</span> contentType <span style="color:#666">=</span> <span style="color:#666">6</span>; <span style="color:#080;font-style:italic">//sending content type. For example 1: text, 2: file, 3: audio, 4: video....
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>  <span style="color:#0b0;font-weight:bold">int32</span> type <span style="color:#666">=</span> <span style="color:#666">7</span>; <span style="color:#080;font-style:italic">//For example: &#34;heatbeat&#34; for checking server/client health , video call/audio call -&gt;&#34;webrtc&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>  <span style="color:#0b0;font-weight:bold">int32</span> messageType <span style="color:#666">=</span> <span style="color:#666">8</span>; <span style="color:#080;font-style:italic">//1: single 2: group
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>  <span style="color:#0b0;font-weight:bold">string</span> groupName <span style="color:#666">=</span> <span style="color:#666">9</span>; <span style="color:#080;font-style:italic">// will have data iff messageType = 2
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>  <span style="color:#0b0;font-weight:bold">string</span> groupAvatar <span style="color:#666">=</span> <span style="color:#666">10</span>; <span style="color:#080;font-style:italic">//will have data iff messageType = 2
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>  <span style="color:#0b0;font-weight:bold">string</span> urlPath <span style="color:#666">=</span> <span style="color:#666">11</span>; <span style="color:#080;font-style:italic">//file url path or other path
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>  <span style="color:#0b0;font-weight:bold">string</span> fileName <span style="color:#666">=</span> <span style="color:#666">12</span>; <span style="color:#080;font-style:italic">//sending file name
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>  <span style="color:#0b0;font-weight:bold">int32</span> fileSize <span style="color:#666">=</span> <span style="color:#666">13</span>; <span style="color:#080;font-style:italic">//sending file size 
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>  <span style="color:#0b0;font-weight:bold">int32</span> storyAvailableTime <span style="color:#666">=</span> <span style="color:#666">14</span>; <span style="color:#080;font-style:italic">//reply story created time
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>}<span style="">
</span></span></span></code></pre></div><ul>
<li>avatar : sender&rsquo;s avatar URL path</li>
<li>fromUserName : sender name</li>
<li>fromUUID ： sender uuid</li>
<li>toUUID : receiver uuid</li>
<li>content :content</li>
<li>contentType ： content type - TEXT/IMAGE etc.</li>
<li>type : Type of message - Heart /RTC/ Message etc.</li>
<li>messageType : message Type - Single Or Group</li>
<li>groupName : Group name</li>
<li>groupAvatar : Group avatar URL path</li>
<li>urlPath : content URL path - File/Image etc.</li>
<li>fileName : File name</li>
<li>fileSize : File size</li>
<li>storyAvailableTime : shared story time</li>
</ul>
<p><code>contentType</code> defination</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-golang" data-lang="golang"><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">const</span> (
</span></span><span style="display:flex;"><span>	TEXT = <span style="color:#a2f;font-weight:bold">iota</span> <span style="color:#666">+</span> <span style="color:#666">1</span>
</span></span><span style="display:flex;"><span>	IMAGE
</span></span><span style="display:flex;"><span>	FILE
</span></span><span style="display:flex;"><span>	AUDIO
</span></span><span style="display:flex;"><span>	VIDEO
</span></span><span style="display:flex;"><span>	STORY 
</span></span><span style="display:flex;"><span>	SYS
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><p>The meaning of 7 content types<br>
<strong>messageType</strong> will be <code>1(single chat)/2(Group chat)</code>，and <strong>type</strong> will be <code>4</code>:</p>
<ul>
<li>TEXT - Only<code> content</code> has data</li>
<li>IMAGE -  <code>urlPath</code>  image URL path</li>
<li>FILE - <code>urlPath</code> has image URL path,<code>fileName</code> has the file name ,<code>fileSize</code> has the file size</li>
<li>AUDIO - <code>urlPath</code> has audio file url</li>
<li>VIDEO - <code>urlPath</code> has video file url</li>
<li>STORY - is an Instance story type，<code>urlPath</code> has story url path ，<code>storyAvailableTime</code> has the story available time</li>
</ul>
<p><strong>messageType</strong> will be 2(Group chat) only，and <strong>type</strong> will be 4。</p>
<ul>
<li>SYS - System message ,<code>content</code> has the message of the SYS。</li>
</ul>
<h4 id="how-does-the-format-work-in-communication">How does the format work in communication?？</h4>
<p><strong>A: Sender(UUID:123)，B: Receiver(UUID:321)</strong>。</p>
<h5 id="situation-1-sending-texe">Situation 1: Sending texe</h5>
<p>A send <code>Hello!</code> to B：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">&#34;avatar&#34;</span>:<span style="color:#b44">&#34;/default.jpg&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">&#34;fromUserName&#34;</span>:<span style="color:#b44">&#34;A&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">&#34;fromUUID&#34;</span> : <span style="color:#b44">&#34;123&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">&#34;toUUID&#34;</span> : <span style="color:#b44">&#34;321&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">&#34;content&#34;</span> : <span style="color:#b44">&#34;Hello!&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">&#34;contentType&#34;</span>:<span style="color:#666">1</span>, <span style="color:#080;font-style:italic">//1: text,
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>    <span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#666">4</span>, <span style="color:#080;font-style:italic">//4: message
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>    <span style="color:#008000;font-weight:bold">&#34;messageType&#34;</span> : <span style="color:#666">1</span>, <span style="color:#080;font-style:italic">//1: single chat
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>}
</span></span></code></pre></div><p>B received message:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">&#34;avatar&#34;</span>:<span style="color:#b44">&#34;/default.jpg&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">&#34;fromUserName&#34;</span>:<span style="color:#b44">&#34;A&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">&#34;fromUUID&#34;</span> : <span style="color:#b44">&#34;123&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">&#34;toUUID&#34;</span> : <span style="color:#b44">&#34;321&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">&#34;content&#34;</span> : <span style="color:#b44">&#34;Hello!&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">&#34;contentType&#34;</span>:<span style="color:#666">1</span>, <span style="color:#080;font-style:italic">//1 : text,
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>    <span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#666">4</span>, <span style="color:#080;font-style:italic">//4: message
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>    <span style="color:#008000;font-weight:bold">&#34;messageType&#34;</span> : <span style="color:#666">1</span>, <span style="color:#080;font-style:italic">//1: single chat
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>}
</span></span></code></pre></div><hr>
<h5 id="situation-2-sending-image">Situation 2 ：Sending image</h5>
<ol>
<li>Uploading the image to sever and obtaining the image path</li>
<li>Sending the path to B</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">&#34;code&#34;</span>:<span style="color:#666">200</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">&#34;path&#34;</span>:<span style="color:#b44">&#34;/image.jpg&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>A sending to image to B：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">&#34;avatar&#34;</span>:<span style="color:#b44">&#34;/default.jpg&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">&#34;fromUserName&#34;</span>:<span style="color:#b44">&#34;A&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">&#34;fromUUID&#34;</span> : <span style="color:#b44">&#34;123&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">&#34;toUUID&#34;</span> : <span style="color:#b44">&#34;321&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">&#34;contentType&#34;</span>:<span style="color:#666">2</span>, <span style="color:#080;font-style:italic">//2: image,
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>    <span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#666">4</span>, <span style="color:#080;font-style:italic">//4: message
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>    <span style="color:#008000;font-weight:bold">&#34;messageType&#34;</span> : <span style="color:#666">1</span>, <span style="color:#080;font-style:italic">//1: single chat
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>    <span style="color:#008000;font-weight:bold">&#34;urlPath&#34;</span> : <span style="color:#b44">&#34;/image.jpg&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>B received message:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">&#34;avatar&#34;</span>:<span style="color:#b44">&#34;/default.jpg&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">&#34;fromUserName&#34;</span>:<span style="color:#b44">&#34;A&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">&#34;fromUUID&#34;</span> : <span style="color:#b44">&#34;123&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">&#34;toUUID&#34;</span> : <span style="color:#b44">&#34;321&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">&#34;contentType&#34;</span>:<span style="color:#666">1</span>, <span style="color:#080;font-style:italic">//1 : image,
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>    <span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#666">4</span>, <span style="color:#080;font-style:italic">//4 : message
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>    <span style="color:#008000;font-weight:bold">&#34;messageType&#34;</span> : <span style="color:#666">1</span>, <span style="color:#080;font-style:italic">//1: single chat
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>    <span style="color:#008000;font-weight:bold">&#34;urlPath&#34;</span> : <span style="color:#b44">&#34;/image.jpg&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Because of <code>contentType</code> is <code>2</code>,then we know it&rsquo;s a image and <code>urlPath</code> save an image url。</p>
<hr>
<p>The situations above are single chatting, what about group chat?</p>
<p>Because the recipient of the group chat will be the UUID of the group, if it is not processed, the sender will be the person who sent the message, and an error will occur when processing on the Client-side (because the sender is A, not the group)</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>Solution：
</span></span><span style="display:flex;"><span>Sender : A -&gt; Group // A send a message to group
</span></span><span style="display:flex;"><span>Receiver : B &lt;- Group // B receive a menssage from group
</span></span></code></pre></div><p><strong>A : Sender(UUID:123)，B : Receiver(UUID:321), Group G: (UUID:G123)</strong>。</p>
<h5 id="situation-1sending-text">Situation 1：Sending text</h5>
<p>A send <code>Hello!</code> to group G：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">&#34;avatar&#34;</span>:<span style="color:#b44">&#34;/default.jpg&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">&#34;fromUserName&#34;</span>:<span style="color:#b44">&#34;A&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">&#34;fromUUID&#34;</span> : <span style="color:#b44">&#34;123&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">&#34;toUUID&#34;</span> : <span style="color:#b44">&#34;G123&#34;</span>, <span style="color:#080;font-style:italic">//Group UUID : G123
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>    <span style="color:#008000;font-weight:bold">&#34;content&#34;</span> : <span style="color:#b44">&#34;Hello!&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">&#34;contentType&#34;</span>:<span style="color:#666">1</span>, <span style="color:#080;font-style:italic">//1 :text,
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>    <span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#666">4</span>, <span style="color:#080;font-style:italic">//4 : message
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>    <span style="color:#008000;font-weight:bold">&#34;messageType&#34;</span> : <span style="color:#666">2</span>, <span style="color:#080;font-style:italic">//2 : group chat
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>    <span style="color:#008000;font-weight:bold">&#34;groupName&#34;</span>:<span style="color:#b44">&#34;groupName#1&#34;</span>, <span style="color:#080;font-style:italic">//UUID：G123&#39;s group name
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>    <span style="color:#008000;font-weight:bold">&#34;groupAvatar&#34;</span>:<span style="color:#b44">&#34;/defaultGroup.jpg&#34;</span>, <span style="color:#080;font-style:italic">//UUID：G123&#39;s group avatar
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>}
</span></span></code></pre></div><p>B received message:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">&#34;avatar&#34;</span>:<span style="color:#b44">&#34;/default.jpg&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">&#34;fromUserName&#34;</span>:<span style="color:#b44">&#34;A&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">&#34;fromUUID&#34;</span> : <span style="color:#b44">&#34;G123&#34;</span>, <span style="color:#080;font-style:italic">//Group UUID : G123
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>    <span style="color:#008000;font-weight:bold">&#34;toUUID&#34;</span> : <span style="color:#b44">&#34;321&#34;</span>, <span style="color:#080;font-style:italic">//receiver uuid : 321
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>    <span style="color:#008000;font-weight:bold">&#34;content&#34;</span> : <span style="color:#b44">&#34;Hello!&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">&#34;contentType&#34;</span>:<span style="color:#666">1</span>, <span style="color:#080;font-style:italic">//1 : Text,
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>    <span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#666">4</span>, <span style="color:#080;font-style:italic">//4 : message
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>    <span style="color:#008000;font-weight:bold">&#34;messageType&#34;</span> : <span style="color:#666">2</span>, <span style="color:#080;font-style:italic">//2: group chat
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>    <span style="color:#008000;font-weight:bold">&#34;groupName&#34;</span>:<span style="color:#b44">&#34;groupName#1&#34;</span>, <span style="color:#080;font-style:italic">//UUID：G123 - group name
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>    <span style="color:#008000;font-weight:bold">&#34;groupAvatar&#34;</span>:<span style="color:#b44">&#34;/defaultGroup.jpg&#34;</span>, <span style="color:#080;font-style:italic">//UUID：G123 - group avatar
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>}
</span></span></code></pre></div><hr>
<h5 id="situationsending-image">Situation：Sending image</h5>
<ol>
<li>Uploading the image to sever and obtaining the image path</li>
<li>Sending the path to Group G</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">&#34;code&#34;</span>:<span style="color:#666">200</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">&#34;path&#34;</span>:<span style="color:#b44">&#34;/image.jpg&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>A sending image to group G：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">&#34;avatar&#34;</span>:<span style="color:#b44">&#34;/default.jpg&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">&#34;fromUserName&#34;</span>:<span style="color:#b44">&#34;A&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">&#34;fromUUID&#34;</span> : <span style="color:#b44">&#34;123&#34;</span>, <span style="color:#080;font-style:italic">//sender UUID
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>    <span style="color:#008000;font-weight:bold">&#34;toUUID&#34;</span> : <span style="color:#b44">&#34;G123&#34;</span>, <span style="color:#080;font-style:italic">//group UUID
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>    <span style="color:#008000;font-weight:bold">&#34;contentType&#34;</span>:<span style="color:#666">2</span>, <span style="color:#080;font-style:italic">//2 : image,
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>    <span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#666">4</span>, <span style="color:#080;font-style:italic">//4 : message
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>    <span style="color:#008000;font-weight:bold">&#34;messageType&#34;</span> : <span style="color:#666">2</span>, <span style="color:#080;font-style:italic">//2 : group chat
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>    <span style="color:#008000;font-weight:bold">&#34;urlPath&#34;</span> : <span style="color:#b44">&#34;/image.jpg&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">&#34;groupName&#34;</span>:<span style="color:#b44">&#34;groupName#1&#34;</span>, <span style="color:#080;font-style:italic">//UUID：G123 - group name
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>    <span style="color:#008000;font-weight:bold">&#34;groupAvatar&#34;</span>:<span style="color:#b44">&#34;/defaultGroup.jpg&#34;</span>, <span style="color:#080;font-style:italic">//UUID：G123 - group avatar
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>}
</span></span></code></pre></div><p>B received message:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">&#34;avatar&#34;</span>:<span style="color:#b44">&#34;/default.jpg&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">&#34;fromUserName&#34;</span>:<span style="color:#b44">&#34;A&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">&#34;fromUUID&#34;</span> : <span style="color:#b44">&#34;G123&#34;</span>, <span style="color:#080;font-style:italic">//group UUID
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>    <span style="color:#008000;font-weight:bold">&#34;toUUID&#34;</span> : <span style="color:#b44">&#34;321&#34;</span>, <span style="color:#080;font-style:italic">//receiver UUID
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>    <span style="color:#008000;font-weight:bold">&#34;contentType&#34;</span>:<span style="color:#666">2</span>, <span style="color:#080;font-style:italic">//2 : image,
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>    <span style="color:#008000;font-weight:bold">&#34;type&#34;</span>: <span style="color:#666">4</span>, <span style="color:#080;font-style:italic">//4 : message
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>    <span style="color:#008000;font-weight:bold">&#34;messageType&#34;</span> : <span style="color:#666">2</span>, <span style="color:#080;font-style:italic">//2: group chat
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>    <span style="color:#008000;font-weight:bold">&#34;urlPath&#34;</span> : <span style="color:#b44">&#34;/image.jpg&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#008000;font-weight:bold">&#34;groupName&#34;</span>:<span style="color:#b44">&#34;groupName#1&#34;</span>, <span style="color:#080;font-style:italic">//UUID：G123 - group name
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>    <span style="color:#008000;font-weight:bold">&#34;groupAvatar&#34;</span>:<span style="color:#b44">&#34;/defaultGroup.jpg&#34;</span>, <span style="color:#080;font-style:italic">//UUID：G123 - group avatar
</span></span></span><span style="display:flex;"><span><span style="color:#080;font-style:italic"></span>}
</span></span></code></pre></div><p>These examples are the baisc usage of commnication by defined format. Although only two usages are explained, the same applies to other types, just the information is different! 😁</p>
<h4 id="you-may-ask-during-the-communication-if-the-receiver-is-not-online-will-the-message-be-gone">You may ask： During the communication, if the receiver is not online, will the message be gone??</h4>
<p>That is a good question! I have struggled with this issue for a long time and finally found a solution.Is to save the message up and re-send it to the offline user when they are online again.
In this app, I used Redis to implement this solution because when users receive offline messages successfully, they will be removed. In comparison to SQL, we will operate it frequently, which will affect its performance. So I decided not to use SQL to do this.</p>
<blockquote>
<p>Retrieved user offline message</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-golang" data-lang="golang"><span style="display:flex;"><span>len, err <span style="color:#666">:=</span> variable.RedisConnection.<span style="color:#00a000">LLen</span>(ctx, u.Uuid).<span style="color:#00a000">Result</span>()
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">if</span> err <span style="color:#666">!=</span> <span style="color:#a2f;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>    logx.<span style="color:#00a000">Error</span>(<span style="color:#b44">&#34;getting Redis length err &#34;</span>, err)
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>messages, err <span style="color:#666">:=</span> svcCtx.RedisClient.<span style="color:#00a000">LRange</span>(ctx, u.Uuid, <span style="color:#666">0</span>, len).<span style="color:#00a000">Result</span>()
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">if</span> err <span style="color:#666">!=</span> <span style="color:#a2f;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>    w.<span style="color:#00a000">WriteHeader</span>(http.StatusBadRequest)
</span></span><span style="display:flex;"><span>    logx.<span style="color:#00a000">Errorf</span>(<span style="color:#b44">&#34;get offline messages error %s &#34;</span>, err.<span style="color:#00a000">Error</span>())
</span></span><span style="display:flex;"><span>    <span style="color:#a2f;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><blockquote>
<p>Added user offline message into redis</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-golang" data-lang="golang"><span style="display:flex;"><span>ctx <span style="color:#666">:=</span> context.<span style="color:#00a000">Background</span>()
</span></span><span style="display:flex;"><span>_, err <span style="color:#666">:=</span> variable.RedisConnection.<span style="color:#00a000">RPush</span>(ctx, mem.MemberInfo.Uuid, messageBytes).<span style="color:#00a000">Result</span>()
</span></span><span style="display:flex;"><span><span style="color:#a2f;font-weight:bold">if</span> err <span style="color:#666">!=</span> <span style="color:#a2f;font-weight:bold">nil</span> {
</span></span><span style="display:flex;"><span>    logx.<span style="color:#00a000">Error</span>(<span style="color:#b44">&#34;offline message to redis err %s&#34;</span>, err.<span style="color:#00a000">Error</span>())
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Every offline message is just serialized to a string. When we need the offline message, just obtain the string and deserialize it. It&rsquo;s easy to send it back to the user!</p>
<h3 id="final-version-demo">Final version Demo</h3>
<p><video src="/videos/chat-app/chat-app-final.mp4" controls="controls" width="500"></video></p>
<h3 id="source-code">Source Code</h3>
<p><a href="https://github.com/RyanTokManMokMTM/swiftui-chat-app">Frontend</a><br>
<a href="https://github.com/RyanTokManMokMTM/chat-app-server">Backend</a></p>

    </div>
          
    <footer class="post-footer">
     
 
<div class="post-tags">     
    
    <a href="/en/tags/side-project" rel="tag" title="side-project">#side-project#</a>
    
</div>



     
     <div class="post-nav">
<div class="article-copyright">
    
    <div class="article-copyright-info">
        <p> 
            <span>Declaration：</span>[Development Diary] Real Time Communication APP(IV) - Final
        </p>
        <p> 
            <span>Link：</span>http://localhost:1313/en/post/chat-app-final/
        </p>
        <p> 
            <span>Author：</span>jackson.tmm
        </p>
        <p> 
            <span>Declaration： </span>This blog post article is under the <a href='https://creativecommons.org/licenses/by-nc-sa/3.0/' target='_blank' style='text-decoration: underline;'>CC BY-NC-SA 3.0</a> license,Please indicate the source!
        </p>
    </div>
</div>
<div class="clear"></div>
</div>
     
     <div class="post-nav">
    <div class="post-nav-next post-nav-item">
    
        <a href="http://localhost:1313/en/post/chat-app-voice-chat/" rel="next" title="[Development Diary] Real Time Communication APP - RTC Updated">
        <i class="fa fa-chevron-left"></i> [Development Diary] Real Time Communication APP - RTC Updated
        </a>
    
    </div>

    <div class="post-nav-prev post-nav-item">
    
        <a href="http://localhost:1313/en/post/chat-app-update/" rel="prev" title="[Development Diary] Real Time Communication APP(III) - Chatting updated">
        [Development Diary] Real Time Communication APP(III) - Chatting updated 
        <i class="fa fa-chevron-right"></i>
        </a>
    
    </div>
</div>  
     








<div id="ucomments"></div>



    </footer>
  </article>
</section>

          </div>
        </div>
        <div class="sidebar-toggle">
  <div class="sidebar-toggle-line-wrap">
    <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
    <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
  </div>
</div>
<aside id="sidebar" class="sidebar">
  <div class="sidebar-inner">

    <section class="site-overview sidebar-panel  sidebar-panel-active ">
      <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image"
        src="/images/avatar.jpg"
        alt="jackson.tmm" />
    <p class="site-author-name" itemprop="name">jackson.tmm</p>
    <p class="site-description motion-element" itemprop="description"> 
      
        Finding the meaning of life &amp; Enjoy the life
      
    </p>
</div>
      <nav class="site-state motion-element">
    <div class="site-state-item site-state-posts">
      <a href="/en/post/">
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">Blogs</span>
      </a>
    </div>
    <div class="site-state-item site-state-categories">    
        <a href="/en/categories/">      
         
        <span class="site-state-item-count">16</span>
        
        <span class="site-state-item-name">Categories</span>
        
        </a>
    </div>

    <div class="site-state-item site-state-tags">
        <a href="/en/tags/">
         
        <span class="site-state-item-count">43 </span>
        
        <span class="site-state-item-name">Tags</span>
        </a>
    </div>
</nav>
      
      
<div class="links-of-author motion-element">
    
        <span class="links-of-author-item">
        <a href="https://github.com/RyanTokManMokMTM" target="_blank" title="GitHub">
            <i class="fa fa-fw fa-github"></i>
            GitHub
        </a>
        </span>
    
        <span class="links-of-author-item">
        <a href="https://www.facebook.com/karot.ka.7505/" target="_blank" title="Facebook">
            <i class="fa fa-fw fa-facebook"></i>
            Facebook
        </a>
        </span>
    
        <span class="links-of-author-item">
        <a href="https://www.instagram.com/tm_m.0418/" target="_blank" title="Instagram">
            <i class="fa fa-fw fa-instagram"></i>
            Instagram
        </a>
        </span>
    
        <span class="links-of-author-item">
        <a href="https://www.linkedin.com/in/jackson-moktokman/" target="_blank" title="Linkedin">
            <i class="fa fa-fw fa-linkedin"></i>
            Linkedin
        </a>
        </span>
    
</div>


      

      
    <div class="tagcloud-of-blogroll motion-element tagcloud-of-blogroll-inline">
    <div class="tagcloud-of-blogroll-title">
        <i class="fa fa-fw fa-tags"></i>
        TagCloud
    </div>
    <ul class="tagcloud-of-blogroll-list">
        
        <li  class="tagcloud-of-blogroll-item">
            <a href="/en/tags/array">Array</a>
        </li>
        
        <li  class="tagcloud-of-blogroll-item">
            <a href="/en/tags/side-project">Side project</a>
        </li>
        
        <li  class="tagcloud-of-blogroll-item">
            <a href="/en/tags/binary-tree">Binary tree</a>
        </li>
        
        <li  class="tagcloud-of-blogroll-item">
            <a href="/en/tags/string">String</a>
        </li>
        
        <li  class="tagcloud-of-blogroll-item">
            <a href="/en/tags/recursion">Recursion</a>
        </li>
        
        <li  class="tagcloud-of-blogroll-item">
            <a href="/en/tags/recursive">Recursive</a>
        </li>
        
        <li  class="tagcloud-of-blogroll-item">
            <a href="/en/tags/stack">Stack</a>
        </li>
        
        <li  class="tagcloud-of-blogroll-item">
            <a href="/en/tags/japen">Japen</a>
        </li>
        
        <li  class="tagcloud-of-blogroll-item">
            <a href="/en/tags/jp">Jp</a>
        </li>
        
        <li  class="tagcloud-of-blogroll-item">
            <a href="/en/tags/priority-queue">Priority queue</a>
        </li>
        
        <li  class="tagcloud-of-blogroll-item">
            <a href="/en/tags/app-dev">App dev</a>
        </li>
        
        <li  class="tagcloud-of-blogroll-item">
            <a href="/en/tags/dfs">Dfs</a>
        </li>
        
        <li  class="tagcloud-of-blogroll-item">
            <a href="/en/tags/dp">Dp</a>
        </li>
        
        <li  class="tagcloud-of-blogroll-item">
            <a href="/en/tags/dynamic-programming">Dynamic programming</a>
        </li>
        
        <li  class="tagcloud-of-blogroll-item">
            <a href="/en/tags/hash-map">Hash map</a>
        </li>
        
        <li  class="tagcloud-of-blogroll-item">
            <a href="/en/tags/heap">Heap</a>
        </li>
        
        <li  class="tagcloud-of-blogroll-item">
            <a href="/en/tags/ios-app">Ios app</a>
        </li>
        
        <li  class="tagcloud-of-blogroll-item">
            <a href="/en/tags/map">Map</a>
        </li>
        
        <li  class="tagcloud-of-blogroll-item">
            <a href="/en/tags/two-pointer">Two pointer</a>
        </li>
        
        <li  class="tagcloud-of-blogroll-item">
            <a href="/en/tags/2023">2023rd</a>
        </li>
        
    </ul>
    </div>


      
    </section>
    
  </div>
</aside>

      </div>
    </main>
   
    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  <span class="copyright-year">  
    &copy; 2022 - 2024
  </span>
  <span class="with-love"><i class="fa fa-heart"></i></span>
  <span class="copyright-author">Jackson.tmm</span>
</div>
<div class="powered-info">
  <span class="powered-by">
    Powered by - <a class="powered-link" href="//gohugo.io" target="_blank" title="hugo" >Hugo v0.125.2</a>
  </span>
  <span class="separator-line">/</span>
  <span class="theme-info">
    Theme by - <a class="powered-link" href="//github.com/elkan1788/hugo-theme-next" target="_blank"> NexT
    </a>
  </span>
</div>
<div class="vistor-info">


</div>

<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/live2d-widget@3.1.4/lib/L2Dwidget.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/live2d-widget@3.1.4/lib/L2Dwidget.0.min.js"></script>
<div class="pio-container right">
  <div class="pio-action"></div>
  <canvas id="pio" width="300" height="500" style="margin: 100;"></canvas>
</div>




      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
      <span id="scrollpercent"><span>0</span>%</span>
    </div>
  </div>

  <script type="text/javascript" src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
<script type="text/javascript" src="/js/search.js"></script>
<script type="text/javascript" src="/js/affix.js"></script>
<script type="text/javascript" src="/js/scrollspy.js"></script> 

<script type="text/javascript">

  function detectIE() {
    var ua = window.navigator.userAgent;

    var msie = ua.indexOf('MSIE ');
    var trident = ua.indexOf('Trident/');
    var edge = ua.indexOf('Edge/');

    if (msie>0 || trident>0 || edge>0) {
      return -1;
    }

    return 1;
  }


  function getCntViewHeight() {
    var docHeight = $('#content').height(),
        winHeight = $(window).height(),
        cntViewHeight = (docHeight > winHeight) ? (docHeight - winHeight) : ($(document).height() - winHeight);
    return cntViewHeight;
  }

  function getScrollbarWidth() {
    var $div = $('<div />').addClass('scrollbar-measure').prependTo('body');
    var div = $div[0];
    var scrollbarWidth = div.offsetWidth - div.clientWidth;

    $div.remove();

    return scrollbarWidth;
  }

  function registerBackTop() {
    var THRESHOLD = 50;
    var $top = $('.back-to-top');

    $(window).on('scroll', function () {
      $top.toggleClass('back-to-top-on', window.pageYOffset > THRESHOLD);

      var scrollTop = $(window).scrollTop();
      var cntViewHeight = getCntViewHeight();
      var scrollPercent = (scrollTop) / (cntViewHeight);
      var scrollPercentRounded = Math.round(scrollPercent*100);
      var scrollPercentMaxed = (scrollPercentRounded > 100) ? 100 : scrollPercentRounded;
      $('#scrollpercent>span').html(scrollPercentMaxed);
    });

    $top.on('click', function () {
      $("html,body").animate({
                 scrollTop: 0,
                 screenLeft: 0,
                 }, 800);
    });
  }

  function initScrollSpy () {
    var tocSelector = '.post-toc';
    var $tocElement = $(tocSelector);
    var activeCurrentSelector = '.active-current';

    $tocElement
      .on('activate.bs.scrollspy', function () {
        var $currentActiveElement = $(tocSelector + ' .active').last();

        removeCurrentActiveClass();
        $currentActiveElement.addClass('active-current');
      })
      .on('clear.bs.scrollspy', removeCurrentActiveClass);

    $('body').scrollspy({ target: tocSelector });

    function removeCurrentActiveClass () {
      $(tocSelector + ' ' + activeCurrentSelector)
        .removeClass(activeCurrentSelector.substring(1));
    }
  }

  function initAffix () {
    var headerHeight = $('.header-inner').height();
    var footerOffset = parseInt($('.main').css('padding-bottom'), 10);
    var sidebarTop = headerHeight + 10;

    $('.sidebar-inner').affix({
      offset: {
        top: sidebarTop,
        bottom: footerOffset
      }
    });

    $(document)
      .on('affixed.bs.affix', function () {
        updateTOCHeight(document.body.clientHeight - 100);
      });
  }

  function initTOCDimension () {
    var updateTOCHeightTimer;

    $(window).on('resize', function () {
      updateTOCHeightTimer && clearTimeout(updateTOCHeightTimer);

      updateTOCHeightTimer = setTimeout(function () {
        var tocWrapperHeight = document.body.clientHeight - 100;

        updateTOCHeight(tocWrapperHeight);
      }, 0);
    });

    
    updateTOCHeight(document.body.clientHeight - 100);

    
    var scrollbarWidth = getScrollbarWidth();
    $('.post-toc').css('width', 'calc(100% + ' + scrollbarWidth + 'px)');
  }

  function updateTOCHeight (height) {
    height = height || 'auto';
    $('.post-toc').css('max-height', height);
  }

$(function() {

  var sidebarTop = $('.header-inner').height() + 10;
  $('#sidebar').css({ 'margin-top': sidebarTop }).show(); 

  
  var sidebarMt = parseInt($('#sidebar').css('margin-top'));
  var sidebarInHeight = parseInt($('.sidebar-inner').css('height'));
  var sideHeight = sidebarMt + sidebarInHeight;
  var contentHeight = $('.content-wrap').height();

  if (contentHeight < sideHeight) {
    $('.content-wrap').css('min-height', sideHeight);
  }
  
  
  $('.site-nav-toggle').on('click', function () {
    var $siteNav = $('.site-nav');
    var $toggleLine = $('.toggle');
    var ON_CLASS_NAME = 'site-nav-on';
    var CLOSE_CLASS_NAME = 'toggle-close';
    var isSiteNavOn = $siteNav.hasClass(ON_CLASS_NAME);
    var animateAction = isSiteNavOn ? 'slideUp' : 'slideDown';
    var animateCallback = isSiteNavOn ? 'removeClass' : 'addClass';

    $siteNav.stop()[animateAction]('normal', function () {
      $siteNav[animateCallback](ON_CLASS_NAME);
      $toggleLine[animateCallback](CLOSE_CLASS_NAME);
    });

  });

  registerBackTop();
  initScrollSpy();
  initAffix();
  initTOCDimension();

  $('.sidebar-nav-toc').click(function(){
    $(this).addClass('sidebar-nav-active');
    $(this).next().removeClass('sidebar-nav-active');      
    $('.'+$(this).next().attr('data-target')).toggle(500);
    $('.'+$(this).attr('data-target')).toggle(500);
  });

  $('.sidebar-nav-overview').click(function(){
    $(this).addClass('sidebar-nav-active');
    $(this).prev().removeClass('sidebar-nav-active');      
    $('.'+$(this).prev().attr('data-target')).toggle(500);
    $('.'+$(this).attr('data-target')).toggle(500);
  });
});  

</script>





<script src="//cdn.bootcdn.net/ajax/libs/imageviewer/0.1.0/viewer.min.js"></script>
<script type="text/javascript">
$(function() {
  $('.post-body').viewer(); 
});
</script>








<script src="//cdn.jsdelivr.net/npm/leancloud-storage@4.6.1/dist/av-min.js"></script>
<script type="text/javascript">
  function showTime(Counter) {
  var query = new AV.Query(Counter);
  var entries = [];
  var $visitors = $(".leancloud_visitors");
 
  $visitors.each(function () {
    entries.push( $(this).attr("id").trim() );
  });

  query.containedIn('url', entries);
  query.find()
    .then((results) => {
      var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

      if (results.length == 0) {
        $visitors.find(COUNT_CONTAINER_REF).text(0);
        return;
      }

      for (var i = 0; i < results.length; i++) {
        var item = results[i];
        var url = item.get('url');
        var time = item.get('time');
        var element = document.getElementById(url);

        $(element).find(COUNT_CONTAINER_REF).text(time);
      }
      for(var i = 0; i < entries.length; i++) {
        var url = entries[i];
        var element = document.getElementById(url);
        var countSpan = $(element).find(COUNT_CONTAINER_REF);
        if( countSpan.text() == '') {
          countSpan.text(0);
        }
      }
    }, (error) => {
      console.log('Query vistors failed: '+error);
    });
}

function addCount(Counter) {
  var $visitors = $(".leancloud_visitors");
  var url = $visitors.attr('id').trim();
  var title = $visitors.attr('data-flag-title').trim();
  var query = new AV.Query('Counter');
  query.equalTo("url", url);
  query.find().then((results) => {
    if (results.length > 0) {
      var counter = results[0];
      counter.increment('time', 1);
      counter.save(null, {
        query: new AV.Query('Counter').equalTo('url', url),
        fetchWhenSave: true
      }).then((counter) => {
        var $element = $(document.getElementById(url));
        $element.find('.leancloud-visitors-count').text(counter.get('time'));        
      }, (error) => {
        console.log('Update vistor failed: '+error);
      });
    } else {      
      var acl = new AV.ACL();
      acl.setPublicReadAccess(true);
      acl.setPublicWriteAccess(true);
     
      var newCounter = new Counter();
      newCounter.set("title", title);
      newCounter.set("url", url);
      newCounter.set("time", 1);

      newCounter.setACL(acl);
      newCounter.save().then((counter) => {
        
      var $element = $(document.getElementById(url));
      $element.find('.leancloud-visitors-count').text(newCounter.get('time'));
    }, (error) => {
      console.log("Save new vistor failed: "+error);
    });
  }}); 
}

$(function() {

  AV.init({
    appId: "JyrUwPHC7QNF67JQSvMaF3Dv-MdYXbMMI",
    appKey: "Uub02Q0GnVDepc8vmgqRavmr",
    serverURL: "https:\/\/blogger-chat-server.vercel.app\/"
  });  

  const Counter = AV.Object.extend("Counter");

  if ($('.leancloud_visitors').length == 1) {
    addCount(Counter);
  } else if ($('.post-title-link').length > 1) {
    showTime(Counter);
  }
});
</script>






<script type="text/javascript">
  (function() {
      var utterances = document.createElement('script');
      utterances.type = 'text/javascript';
      utterances.async = true;
      utterances.setAttribute('issue-term',"pathname")
      utterances.setAttribute('theme',"github-light")
      utterances.setAttribute('repo',"RyanTokManMokMTM\/RyanTokManMokMTM.github.io")
      utterances.crossorigin = 'anonymous';
      utterances.src = 'https://utteranc.es/client.js';
      document.getElementById('ucomments').appendChild(utterances);
  })();
</script>











<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https'){
   bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
  }
  else{
    bp.src = 'http://push.zhanzhang.baidu.com/push.js';
  }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>







<script src='/js/l2d.js'></script>

<script src='/js/pio.js'></script>
<script src="/js/APlayer.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.pjax/1.9.6/jquery.pjax.min.js"></script>
<script src="https://static.elfsight.com/platform/platform.js" data-use-service-core defer></script>

<script>
  const ap = new APlayer({
    container: document.getElementById('aplayer'),
    fixed: true,
    autoplay: false,
    theme: '#b7daff',
    loop: 'all',
    order: 'list',
    preload: 'auto',
    volume: 0.7,
    mutex: true,
    listFolded: false,
    listMaxHeight: '200px',
    lrcType: 0,
    audio: [{
        name: 'グランドエスケープ',
        artist: '三浦透子',
        url: '/music/src/music1.mp3',
        cover: '/images/music/thum/music1.jpg',
    },
    ]
});

</script>
<script>
  var pio = new Paul_Pio({
      "mode": "draggable",
      "hidden": true,
      "content": {
          "welcome": ["歡迎來到Jackson的小宇宙！", "今天天氣不錯，一起来玩吧！", "博主有空的話，會寫一寫博客記錄一下!"],
          "custom": [
              
              {"selector": ".home-social a:last-child", "text": "在這里可以了解博主的日常噢~"},
              {"selector": ".post-item a", "type": "read"},
              {"selector": ".post-content a, .page-content a", "type": "link"}
          ]
      },
      
      "model": [
        "/model/umaru/model.json",
        "/model/tororo/tororo.model.json",
        "/model/HN/nepmaid/model.json",
        "/model/HN/nepgearswim/model.json",
        "/model/HN/neptune_santa/model.json",
        "/model/other/rem/model.json",
        "/model/other/mei/model.json", 
        "/model/other/liang/2.json", 
        "/model/HN/noir_santa/model.json",
        "/model/HN/noireswim/model.json",
        "/model/other/blanc_normal/index.json",
        "/model/other/88type_1809/normal/model.json",
        "/model/other/88type_1809/destroy/model.json",
        "/model/other/dsr50_1801/normal/model.json",
        "/model/other/dsr50_1801/destroy/model.json",
        "/model/other/g36c_1202/normal/model.json",
        "/model/other/g36c_1202/destroy/model.json",
        "/model/other/kp31_310/normal/model.json",
        "/model/other/kp31_310/destroy/model.json",
        "/model/other/kp31_1103/normal/model.json",
        "/model/other/kp31_1103/destroy/model.json",
      ],
        touch: ["不可以這樣欺負我啦><"]
  })

</script>

  <div class="elfsight-app-b04b61d3-ff26-4d9d-a289-163c1b59bd32" data-elfsight-app-lazy></div>
</body>
</html>