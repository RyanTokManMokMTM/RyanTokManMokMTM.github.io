<!doctype html><html lang=zh-TW data-theme=dark><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset=UTF-8><meta name=viewport content="width=device-width"><meta name=theme-color content="#222" media="(prefers-color-scheme: dark)"><meta name=generator content="Hugo 0.134.2"><link rel="shortcut icon" type=image/x-icon href=/imgs/customIcon/favicon.ico><link rel=icon type=image/x-icon href=/imgs/customIcon/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/imgs/customIcon/favicon_16x16.png><link rel=icon type=image/png sizes=32x32 href=/imgs/customIcon/favicon_32_32.png><link rel=apple-touch-icon sizes=180x180 href=/imgs/icons/apple_touch_icon_next.png><meta itemprop=name content="[開發者日記] 聊天通訊APP(四) - 最終章"><meta itemprop=description content="簡單紀錄生活和筆記"><meta name=description content="簡單紀錄生活和筆記"><meta itemprop=datePublished zgotmplz><meta itemprop=dateModified zgotmplz><meta itemprop=image content="http://localhost:1313/imgs/customIcon/avatar.jpg"><meta itemprop=keywords content="chat-app"><link href=/css/pio.css rel=stylesheet type=text/css><link type=text/css rel=stylesheet href=http://localhost:1313/3rd/font-awesome/6.6.0/css/all.min.css><link type=text/css rel=stylesheet href=http://localhost:1313/3rd/animate.css/4.1.1/animate.min.css><link type=text/css rel=stylesheet href=http://localhost:1313/3rd/viewerjs/1.11.6/viewer.min.css><link rel=stylesheet href=/css/main.css><script type=text/javascript>(function(){localDB={set:function(e,t,n){if(n===0)return;const s=new Date,o=n*864e5,i={value:t,expiry:s.getTime()+o};localStorage.setItem(e,JSON.stringify(i))},get:function(e){const t=localStorage.getItem(e);if(!t)return void 0;const n=JSON.parse(t),s=new Date;return s.getTime()>n.expiry?(localStorage.removeItem(e),void 0):n.value}},theme={active:function(){const e=localDB.get("theme");if(e==null)return;theme.toggle(e),window.matchMedia("(prefers-color-scheme: dark)").addListener(function(e){theme.toggle(e.matches?"dark":"light")})},toggle:function(e){document.documentElement.setAttribute("data-theme",e),localDB.set("theme",e,2);const t=document.querySelector("iframe.giscus-frame");if(t){const n={setConfig:{theme:e}};t.contentWindow.postMessage({giscus:n},"https://giscus.app")}}},theme.active()})(window)</script><script class=next-config data-name=page type=application/json>{"comments":true,"isHome":false,"isPage":true,"path":"chat-app-final","permalink":"http://localhost:1313/post/project/chat-app-final/","title":"[開發者日記] 聊天通訊APP(四) - 最終章","waline":{"js":[{"alias":"@waline/client","alias_name":"waline","file":"dist/pageview.js","name":"pageview","version":"2.15.8"},{"alias":"@waline/client","alias_name":"waline","file":"dist/comment.js","name":"comment","version":"2.15.8"}]}}</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{var e=document.createElement("script");e.charset="UTF-8",e.id="LA_COLLECT",e.src="https://sdk.51.la/js-sdk-pro.min.js",e.async="true",e.onload=function(){LA.init({id:"JiZkaipzkPyiCL8x",ck:"JiZkaipzkPyiCL8x",autoTrack:!0})},document.head.appendChild(e)})</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{var e=document.createElement("script");e.charset="UTF-8",e.src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js",e.async=!1,e.defer=!0,document.head.appendChild(e),e.onload=function(){NexT.utils.fmtBusuanzi()}})</script><title>[開發者日記] 聊天通訊APP(四) - 最終章 - Jackson.tmm</title><noscript><link rel=stylesheet href=/css/noscript.css></noscript></head><body itemscope itemtype=http://schema.org/WebPage class=use-motion><div class=headband></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><a href=/ class=brand rel=start><i class=logo-line></i><h1 class=site-title>Jackson.tmm</h1><i class=logo-line></i></a><p class=site-subtitle itemprop=description>Loving life and dreams.</p></div><div class=site-nav-right><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-home hvr-icon"></i>Home 首頁</a></li><li class="menu-item menu-item-categories"><a href=/categories/ class=hvr-icon-pulse rel=section><i class="fa fa-list hvr-icon"></i>Menu 目錄</a></li><li class="menu-item menu-item-about"><a href=/about.html class=hvr-icon-pulse rel=section><i class="fa fa-user hvr-icon"></i>About 關於</a></li><li class="menu-item menu-item-post"><a href=/post/ class=hvr-icon-pulse rel=section><i class="fa fa-archive hvr-icon"></i>Archive 歸檔</a></li><li class="menu-item menu-item-memories"><a href=/memories class=hvr-icon-pulse rel=section><i class="fa fa-star hvr-icon"></i>Memories 回憶</a></li><li class="menu-item menu-item-achievement"><a href=/achievement class=hvr-icon-pulse rel=section><i class="fa fa-trophy hvr-icon"></i>Achievement 成就</a></li><li class="menu-item menu-item-leetcodes"><a href=/leetcodes class=hvr-icon-pulse rel=section><i class="fa fa-code hvr-icon"></i>Leetcodes 力扣</a></li><li class="menu-item menu-item-english"><a href=/english class=hvr-icon-pulse rel=section><i class="fa fa-language hvr-icon"></i>English 英文</a></li><li class="menu-item menu-item-project"><a href=/project class=hvr-icon-pulse rel=section><i class="fa fa-tasks hvr-icon"></i>Project 專案</a></li><li class="menu-item menu-item-resources"><a href=/resources class=hvr-icon-pulse rel=section><i class="fa fa-file hvr-icon"></i>Resources 資源</a></li><li class="menu-item menu-item-search"><a role=button class="popup-trigger hvr-icon-pulse"><i class="fa fa-search fa-fw hvr-icon"></i>搜索</a></li></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon><i class="fa fa-search"></i></span><div class=search-input-container><input autocomplete=off autocapitalize=off maxlength=80 placeholder=搜索... spellcheck=false type=search class=search-input></div><span class=popup-btn-close role=button><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class=search-result-icon><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-overview-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>文章目錄</li><li class=sidebar-nav-overview>站點概覽</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><nav id=TableOfContents><ul><li><ul><li><a href=#簡介>簡介</a></li><li><a href=#tech-stack>Tech Stack</a></li><li><a href=#功能細節後端>功能細節(後端)</a><ul><li><a href=#以上的格式是怎麼用於訊息發送的呢>以上的格式是怎麼用於訊息發送的呢？</a></li><li><a href=#你有可能會問欸如果在通訊的過程中用戶沒有在線或者沒有連接上server哪訊息不就消息了嗎哪用戶不就收不到訊息了>你有可能會問：欸，如果在通訊的過程中，用戶沒有在線或者沒有連接上server，哪訊息不就消息了嗎？哪用戶不就收不到訊息了？</a></li></ul></li><li><a href=#最終demo>最終Demo</a></li><li><a href=#source-code>Source Code</a></li></ul></li></ul></nav></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt=Jackson.tmm src=/imgs/img-lazy-loading.gif data-src=/imgs/customIcon/avatar.jpg><p class=site-author-name itemprop=name>Jackson.tmm</p><div class=site-description itemprop=description>簡單紀錄生活和筆記</div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/post/><span class=site-state-item-count>38</span>
<span class=site-state-item-name>日誌</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>12</span>
<span class=site-state-item-name>分類</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>60</span>
<span class=site-state-item-name>標籤</span></a></div></nav></div><div class="links-of-social site-overview-item animated"><span class=links-of-social-item><a href=https://www.facebook.com/karot.ka.7505/ title="Facebook → https://www.facebook.com/karot.ka.7505/" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-facebook fa-fw hvr-icon"></i>
Facebook
</a></span><span class=links-of-social-item><a href=https://www.instagram.com/tm_m.0418 title="IG → https://www.instagram.com/tm_m.0418" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-instagram fa-fw hvr-icon"></i>
IG
</a></span><span class=links-of-social-item><a href=https://github.com/RyanTokManMokMTM title="Github → https://github.com/RyanTokManMokMTM" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-github fa-fw hvr-icon"></i>
Github
</a></span><span class=links-of-social-item><a href=https://www.linkedin.com/in/jackson-moktokman/ title="LinkedIn → https://www.linkedin.com/in/jackson-moktokman/" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-linkedin fa-fw hvr-icon"></i>
LinkedIn</a></span></div><div class="cc-license animated" itemprop=license><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh class=cc-opacity rel=noopener target=_blank title=共享知識><img src=/imgs/img-lazy-loading.gif data-src=/imgs/cc/big/by_nc_sa.svg alt=共享知識></a></div><div class="links-of-blogroll site-overview-item animated"><div class=links-of-blogroll-title><i class="fa-solid fa-person-praying fa-fw"></i>
友情鏈接</div><ul class=links-of-blogroll-list><li class=links-of-blogroll-item><a href=https://cwksc.github.io/ title=https://cwksc.github.io/ target=_blank>CWKSC 一個什麼都學得會的人</a></li></ul></div></div></div></div><div id=siteinfo-card-widget class=sidebar-card-widget><div class=item-headline><i class="fas fa-chart-line"></i>
<span>網站資訊</span></div><div class=siteinfo><div class=siteinfo-item><div class=item-name><i class="fa-solid fa-calendar-check"></i>已運行：</div><div class=item-count id=runTimes data-publishdate=2022-03-24T13:52:49+08:00></div></div><div id=la-siteinfo-widget style=display:none></div><div class=siteinfo-item><div class=item-name><i class="fa fa-user-plus"></i>今日訪問：</div><div class=item-count id=today_site_pv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-user-clock"></i>昨日訪問：</div><div class=item-count id=yesterday_site_pv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-arrows-down-to-people"></i>本月訪問：</div><div class=item-count id=month_site_pv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-users"></i>總訪問量：</div><div class=item-count id=total_site_pv><i class="fa fa-sync fa-spin"></i></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-font"></i>總字數：</div><div class=item-count id=wordsCount data-count=41038></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-mug-hot"></i>閱讀約：</div><div class=item-count id=readTimes data-times=106></div></div><div class=siteinfo-item><div class=item-name><i class="fa fa-clock-rotate-left"></i>最後更新於：</div><div class=item-count id=last-push-date data-lastpushdate=2024-11-10T15:29:39+08:00></div></div></div></div></aside><div class=sidebar-dimmer></div></header><div class=tool-buttons><div id=goto-comments class="button goto-comments" title=直達評論><i class="fas fa-comments"></i></div><div id=toggle-theme class=button title=深淺模式切換><i class="fas fa-adjust"></i></div><div class=back-to-top role=button title=返回頂部><i class="fa fa-arrow-up"></i>
<span>0%</span></div></div><div class=reading-progress-bar></div><a role=button class="book-mark-link book-mark-link-fixed"></a><a href=https://github.com/RyanTokManMokMTM rel="noopener external nofollow noreferrer" target=_blank title="Follow me on GitHub" class="exturl github-corner"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=http://localhost:1313/post/project/chat-app-final/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/customIcon/avatar.jpg"><meta itemprop=name content="Jackson.tmm"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="Jackson.tmm"><meta itemprop=description content="簡單紀錄生活和筆記"></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="[開發者日記] 聊天通訊APP(四) - 最終章"><meta itemprop=description content="簡介

在之前

    序章
    
中，雖然已經大概介紹過這個app在幹嘛。但是因為這次是最終章的成品展示(或許有些部分沒實現😂)，所以就允許我囉嗦得再說一次吧！
這個app主要是focus在Websocket，也就是實時通訊上。雖然但是HTTP的部分還是不能少的🤣，哈哈哈。所以這個App的Server-side包含了HTTP和Websocket 2個部分。HTTP的部分主要是用作CURD,而Websocket的部分則是用於個人通訊和群組通訊。"></span><header class=post-header><h1 class=post-title itemprop="name headline">[開發者日記] 聊天通訊APP(四) - 最終章</h1><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="fas fa-solid fa-calendar"></i>
</span><span class=post-meta-item-text title=發表於>發表於：
</span><time title="創建時間：2023-05-01 19:25:38 +0800 HKT" itemprop="dateCreated datePublished" datetime="2023-05-01 19:25:38 +0800 HKT">2023-05-01
</time></span><span class=post-meta-item><span class=post-meta-item-icon><i class="fas fa-solid fa-folder-open"></i>
</span><span class=post-meta-item-text title=分類於>分類於：
</span><span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/side-project itemprop=url rel=index><span itemprop=name>side-project</span></a></span></span></div><div class=post-meta-items><span class=post-meta-item title=字數><span class=post-meta-item-icon><i class="fas fa-solid fa-file-word"></i>
</span><span class=post-meta-item-text>字數：</span>
<span>3556</span>
</span><span class=post-meta-item title=閱讀><span class=post-meta-item-icon><i class="fas fa-solid fa-clock"></i>
</span><span class=post-meta-item-text>閱讀：&ap;</span>
<span>8分鐘</span>
</span><span class=post-meta-item title=瀏覽><span class=post-meta-item-icon><i class="fas fa-solid fa-eye"></i>
</span><span class=post-meta-item-text>瀏覽：
</span><span id=busuanzi_value_page_pv data-path=/post/project/chat-app-final/><i class="fa fa-sync fa-spin"></i></span></span></div></div></header><div class=post-body itemprop=articleBody><h3 id=簡介>簡介
<a class=header-anchor href=#%e7%b0%a1%e4%bb%8b></a></h3><p>在之前
<a href=/post/chat-app-init title=序章>序章
</a>中，雖然已經大概介紹過這個app在幹嘛。但是因為這次是<strong>最終章</strong>的成品展示(或許有些部分沒實現😂)，所以就允許我囉嗦得再說一次吧！</p><p>這個app主要是focus在Websocket，也就是實時通訊上。雖然但是HTTP的部分還是不能少的🤣，哈哈哈。所以這個App的Server-side包含了HTTP和Websocket 2個部分。HTTP的部分主要是用作CURD,而Websocket的部分則是用於個人通訊和群組通訊。</p><h3 id=tech-stack>Tech Stack
<a class=header-anchor href=#tech-stack></a></h3><ul><li>SwiftUI</li><li>Golang</li><li>Go-Zero</li><li>Gorm</li><li>Mysql</li><li>Redis</li><li>Docker/Docker-compose</li></ul><p>App的功能如下：</p><ul><li>基礎功能：<ul><li>用戶登入與註冊</li><li>用戶資料修改，包括用戶頭像，名字和狀態訊息(Status Message)</li><li>獲取用戶資訊</li><li>尋找好友(透過名字查找)</li><li>新增/刪除好友</li><li>獲取已加好友列表</li><li>建立群組，其中建立群組可以選擇要邀請加入的好友，在建立時會一同加入到群組中。</li><li>尋找群組(透過群名)</li><li>加入未加入的群組/離開已加入的群組</li><li>群組資訊修改(群組權限)，可修改群組頭像和群組名稱</li><li>獲取群友類表</li><li>獲取已加入群組列表</li></ul></li><li>額外功能:<ul><li>新增用戶的限時動態(24小時)</li><li>獲取用戶好友動態</li><li>獲取特定限時動態</li><li>刪掉特定限時動態</li><li>回覆特定好友之限時動態 - 透過Websocket 發送訊息給動態用戶</li></ul></li><li>核心功能<ul><li>個人聊天 - 透過Websocket 發送訊息</li><li>群組聊天 - 透過Websocket 發送訊息</li><li>各聊天室都支援以下訊息:<ol><li>文字</li><li>圖片(如:jpg,png)</li><li>文件(如:pdf,docx,txt,ppt,etc.)</li><li>音頻(如:wav,mp3)</li><li>視頻(暫只支援mp4)</li></ol></li></ul></li></ul><h3 id=功能細節後端>功能細節(後端)
<a class=header-anchor href=#%e5%8a%9f%e8%83%bd%e7%b4%b0%e7%af%80%e5%be%8c%e7%ab%af></a></h3><p>HTTP API的部分就不一一詳細解說了，也僅僅是CRUD而已，😂哈哈哈。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-gdscript3 data-lang=gdscript3><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>用戶</span>API
</span></span><span style=display:flex><span><span style=color:#f92672>-</span> POST <span style=color:#f92672>/</span>api<span style=color:#f92672>/</span>v1<span style=color:#f92672>/</span>user<span style=color:#f92672>/</span>signup <span style=color:#f92672>-&gt;</span> <span style=color:#960050;background-color:#1e0010>用戶註冊</span>
</span></span><span style=display:flex><span><span style=color:#f92672>-</span> POST <span style=color:#f92672>/</span>api<span style=color:#f92672>/</span>v1<span style=color:#f92672>/</span>user<span style=color:#f92672>/</span>signin <span style=color:#f92672>-&gt;</span> <span style=color:#960050;background-color:#1e0010>用戶登入</span>
</span></span><span style=display:flex><span><span style=color:#f92672>-</span> GET <span style=color:#f92672>/</span>api<span style=color:#f92672>/</span>v1<span style=color:#f92672>/</span>user<span style=color:#f92672>/</span>info <span style=color:#f92672>-&gt;</span> <span style=color:#960050;background-color:#1e0010>獲取特地用戶資訊</span>
</span></span><span style=display:flex><span><span style=color:#f92672>-</span> GET <span style=color:#f92672>/</span>api<span style=color:#f92672>/</span>v1<span style=color:#f92672>/</span>user<span style=color:#f92672>/</span>profile <span style=color:#f92672>-&gt;</span> <span style=color:#960050;background-color:#1e0010>獲取朋友資訊</span>
</span></span><span style=display:flex><span><span style=color:#f92672>-</span> PATCH <span style=color:#f92672>/</span>api<span style=color:#f92672>/</span>v1<span style=color:#f92672>/</span>user<span style=color:#f92672>/</span>info <span style=color:#f92672>-&gt;</span> <span style=color:#960050;background-color:#1e0010>更新資訊</span>
</span></span><span style=display:flex><span><span style=color:#f92672>-</span> PATCH <span style=color:#f92672>/</span>api<span style=color:#f92672>/</span>v1<span style=color:#f92672>/</span>UpdateUserStatus <span style=color:#f92672>-&gt;</span> <span style=color:#960050;background-color:#1e0010>更新狀態資訊</span>
</span></span><span style=display:flex><span><span style=color:#f92672>-</span> POST <span style=color:#f92672>/</span>api<span style=color:#f92672>/</span>v1<span style=color:#f92672>/</span>UploadUserAvatar <span style=color:#f92672>-&gt;</span> <span style=color:#960050;background-color:#1e0010>上傳並更新用戶頭像</span>
</span></span><span style=display:flex><span><span style=color:#f92672>-</span> POST <span style=color:#f92672>/</span>api<span style=color:#f92672>/</span>v1<span style=color:#f92672>/</span>UploadUserCover <span style=color:#f92672>-&gt;</span> <span style=color:#960050;background-color:#1e0010>上傳並更新用戶背景</span>
</span></span><span style=display:flex><span><span style=color:#f92672>-</span> GET <span style=color:#f92672>/</span>api<span style=color:#f92672>/</span>v1<span style=color:#f92672>/</span>user<span style=color:#f92672>/</span>search <span style=color:#f92672>-&gt;</span> <span style=color:#960050;background-color:#1e0010>搜尋用戶</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>群組API
</span></span><span style=display:flex><span>- POST /api/v1/group -&gt; 建立群組
</span></span><span style=display:flex><span>- POST /api/v1/group/join/:group_id -&gt; 加入特定群組
</span></span><span style=display:flex><span>- DELTE /api/v1/group/leave/:group_id -&gt; 離開特定群組
</span></span><span style=display:flex><span>- GET /api/v1/group -&gt; 獲取群組資訊
</span></span><span style=display:flex><span>- GET /api/v1/group/members/:group_id -&gt; 獲取群組人員
</span></span><span style=display:flex><span>- POST /api/v1/group/avatar/:group_id -&gt; 更新群組頭像
</span></span><span style=display:flex><span>- PATCH /api/v1/group -&gt; 更新群組資訊
</span></span><span style=display:flex><span>- GET /api/v1/group/search -&gt; 搜尋群組
</span></span><span style=display:flex><span>- GET /api/v1/group/info/uuid/:uuid -&gt; 以UUID搜尋群組
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>朋友API
</span></span><span style=display:flex><span>- POST /api/v1/user/friend -&gt; 新增好友
</span></span><span style=display:flex><span>- DELETE /api/v1/user/friend -&gt; 刪除好友
</span></span><span style=display:flex><span>- GET /api/v1/user/friends -&gt; 獲取好友列表
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>限時動態API
</span></span><span style=display:flex><span>- POST /api/v1/story -&gt; 新增限時動態
</span></span><span style=display:flex><span>- DELETE /api/v1/story -&gt; 刪除限時動態
</span></span><span style=display:flex><span>- GET /api/v1/stories -&gt; 獲取特地限時動態
</span></span><span style=display:flex><span>- GET /api/v1/stories/active -&gt; 獲取好友限時動態
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>訊息API
</span></span><span style=display:flex><span>- GET /api/v1/message -&gt; 獲取特地群組信息
</span></span><span style=display:flex><span>- DELETE /api/v1/message -&gt; 刪除特別訊息
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-gdscript3 data-lang=gdscript3><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>文件</span>API
</span></span><span style=display:flex><span><span style=color:#f92672>-</span> POST <span style=color:#f92672>/</span>api<span style=color:#f92672>/</span>v1<span style=color:#f92672>/</span>file<span style=color:#f92672>/</span>image<span style=color:#f92672>/</span>upload <span style=color:#f92672>-&gt;</span> <span style=color:#960050;background-color:#1e0010>上傳圖片</span>
</span></span><span style=display:flex><span><span style=color:#f92672>-</span> POST <span style=color:#f92672>/</span>api<span style=color:#f92672>/</span>v1<span style=color:#f92672>/</span>file<span style=color:#f92672>/</span>upload <span style=color:#f92672>-&gt;</span> <span style=color:#960050;background-color:#1e0010>上傳任何文件</span>
</span></span></code></pre></div><p>接下來就核心的Websocket的部分了！<br>因為要進行通訊，那我們就得預先定義好前端和後端都看得懂的格式，否則難以進行溝通。以下是我定義的格式(我是使用ProtoBuffer)：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-protobuf data-lang=protobuf><span style=display:flex><span><span style=color:#66d9ef>message</span> <span style=color:#a6e22e>Message</span> {<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>  <span style=color:#66d9ef>string</span> avatar <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>; <span style=color:#75715e>//user avatar path
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>string</span> fromUserName <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>; <span style=color:#75715e>//sender user name
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>string</span> fromUUID <span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>; <span style=color:#75715e>//sender uuid
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>string</span> toUUID <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>; <span style=color:#75715e>//receiver uuid
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>string</span> content <span style=color:#f92672>=</span> <span style=color:#ae81ff>5</span>; <span style=color:#75715e>//sending content
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>int32</span> contentType <span style=color:#f92672>=</span> <span style=color:#ae81ff>6</span>; <span style=color:#75715e>//sending content type. For example 1: text, 2: file, 3: audio, 4: video....
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>int32</span> type <span style=color:#f92672>=</span> <span style=color:#ae81ff>7</span>; <span style=color:#75715e>//For example: &#34;heatbeat&#34; for checking server/client health , video call/audio call -&gt;&#34;webrtc&#34;
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>int32</span> messageType <span style=color:#f92672>=</span> <span style=color:#ae81ff>8</span>; <span style=color:#75715e>//1: single 2: group
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>string</span> groupName <span style=color:#f92672>=</span> <span style=color:#ae81ff>9</span>; <span style=color:#75715e>// will have data iff messageType = 2
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>string</span> groupAvatar <span style=color:#f92672>=</span> <span style=color:#ae81ff>10</span>; <span style=color:#75715e>//will have data iff messageType = 2
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>string</span> urlPath <span style=color:#f92672>=</span> <span style=color:#ae81ff>11</span>; <span style=color:#75715e>//file url path or other path
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>string</span> fileName <span style=color:#f92672>=</span> <span style=color:#ae81ff>12</span>; <span style=color:#75715e>//sending file name
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>int32</span> fileSize <span style=color:#f92672>=</span> <span style=color:#ae81ff>13</span>; <span style=color:#75715e>//sending file size 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>int32</span> storyAvailableTime <span style=color:#f92672>=</span> <span style=color:#ae81ff>14</span>; <span style=color:#75715e>//reply story created time
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><ul><li>avatar : 用於存放發送者的頭像URL[]</li><li>fromUserName : 發送者的名字</li><li>fromUUID ： 發送者的UUID</li><li>toUUID : 接收者的UUID</li><li>content : 發送的內容,也就是文字內容</li><li>contentType ： 發送的內容類型(這個待會會說有哪些類型)！</li><li>type : 發送的訊息類型，是心跳監測呢？還是系統訊息呢？還是普通的用戶通訊訊息呢？</li><li>messageType : 單人聊天或者群組聊天的訊息</li><li>groupName : 群組的名稱 - 主要用於前端建立房間的緩存</li><li>groupAvatar : 群組的頭像 - 主要用於前端建立房間的緩存</li><li>urlPath : 發送文件的URL，可以是圖片，文件，音頻或者是其他</li><li>fileName : 發送的文件名字 - 用於前端顯示</li><li>fileSize : 發送文件的大小 - 用於前端顯示</li><li>storyAvailableTime : 顯示動態的建立時間 - 用於前端顯示限時動態的是否可用</li></ul><p>剛才說了<code>contentType</code>是發送內容的訊息嘛，那我定義了哪些呢？</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#66d9ef>const</span> (
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>TEXT</span> = <span style=color:#66d9ef>iota</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>IMAGE</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>FILE</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>AUDIO</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>VIDEO</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>STORY</span> 
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>SYS</span>
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><p>從上可見，我定義了7種。這7種分別是什麼呢？<br><strong>messageType</strong> 可以為1(單聊)或者2(群聊)，且<strong>type</strong>為4(訊息類型)</p><ul><li>TEXT - 是純文件類型,只有<code>content</code>中有內容。</li><li>IMAGE - 是圖片類型, <code>urlPath</code>中會有該圖片的url</li><li>FILE - 是文件類型，<code>urlPath</code>包含文件的url,<code>fileName</code>包含文件的名稱,<code>fileSize</code>包含文件的大小</li><li>AUDIO - 是音頻類型，<code>urlPath</code>包含音頻的url</li><li>VIDEO - 是視頻類型，<code>urlPath</code>包含視頻的url</li><li>STORY - 是限時動態類型，<code>urlPath</code>包含了限時動態的url，<code>storyAvailableTime</code>包含了限時動態的建立的時間</li></ul><p><strong>messageType</strong> 只會為2(群聊)，且<strong>type</strong>為4(訊息類型)。<em>因為目前系統訊息用於通知用戶加入，離開群組等訊息。</em></p><ul><li>SYS - 群組系統訊息 ,<code>content</code>中有系統訊息內容。</li></ul><h4 id=以上的格式是怎麼用於訊息發送的呢>以上的格式是怎麼用於訊息發送的呢？
<a class=header-anchor href=#%e4%bb%a5%e4%b8%8a%e7%9a%84%e6%a0%bc%e5%bc%8f%e6%98%af%e6%80%8e%e9%ba%bc%e7%94%a8%e6%96%bc%e8%a8%8a%e6%81%af%e7%99%bc%e9%80%81%e7%9a%84%e5%91%a2></a></h4><p><strong>A為發送者(UUID:123)，B為接收者(UUID:321)</strong>。</p><h5 id=情境一發送文字>情境一：發送文字。
<a class=header-anchor href=#%e6%83%85%e5%a2%83%e4%b8%80%e7%99%bc%e9%80%81%e6%96%87%e5%ad%97></a></h5><p>A 發送<code>Hello!</code>給B，以下是發送內容：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;avatar&#34;</span>:<span style=color:#e6db74>&#34;/default.jpg&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;fromUserName&#34;</span>:<span style=color:#e6db74>&#34;A&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;fromUUID&#34;</span> : <span style=color:#e6db74>&#34;123&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;toUUID&#34;</span> : <span style=color:#e6db74>&#34;321&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;content&#34;</span> : <span style=color:#e6db74>&#34;Hello!&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;contentType&#34;</span>:<span style=color:#ae81ff>1</span>, <span style=color:#75715e>//1 為text,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#ae81ff>4</span>, <span style=color:#75715e>//4 為訊息
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>&#34;messageType&#34;</span> : <span style=color:#ae81ff>1</span>, <span style=color:#75715e>//1為單人聊天
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>B接收的內容如下:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;avatar&#34;</span>:<span style=color:#e6db74>&#34;/default.jpg&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;fromUserName&#34;</span>:<span style=color:#e6db74>&#34;A&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;fromUUID&#34;</span> : <span style=color:#e6db74>&#34;123&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;toUUID&#34;</span> : <span style=color:#e6db74>&#34;321&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;content&#34;</span> : <span style=color:#e6db74>&#34;Hello!&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;contentType&#34;</span>:<span style=color:#ae81ff>1</span>, <span style=color:#75715e>//1 為text,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#ae81ff>4</span>, <span style=color:#75715e>//4 為訊息
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>&#34;messageType&#34;</span> : <span style=color:#ae81ff>1</span>, <span style=color:#75715e>//1為單人聊天
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><hr><h5 id=情境二發送圖片>情境二：發送圖片。
<a class=header-anchor href=#%e6%83%85%e5%a2%83%e4%ba%8c%e7%99%bc%e9%80%81%e5%9c%96%e7%89%87></a></h5><p>在透過websocket發送內容之前，會先透過API上傳圖片到Server，然後Server會回傳圖片的URL。然後再發送該URL即可。<br>假設Server回傳的URL如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;code&#34;</span>:<span style=color:#ae81ff>200</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;path&#34;</span>:<span style=color:#e6db74>&#34;/image.jpg&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>A 發送圖片給B，以下是發送內容：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;avatar&#34;</span>:<span style=color:#e6db74>&#34;/default.jpg&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;fromUserName&#34;</span>:<span style=color:#e6db74>&#34;A&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;fromUUID&#34;</span> : <span style=color:#e6db74>&#34;123&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;toUUID&#34;</span> : <span style=color:#e6db74>&#34;321&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;contentType&#34;</span>:<span style=color:#ae81ff>2</span>, <span style=color:#75715e>//2 為image,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#ae81ff>4</span>, <span style=color:#75715e>//4 為訊息
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>&#34;messageType&#34;</span> : <span style=color:#ae81ff>1</span>, <span style=color:#75715e>//1為單人聊天
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>&#34;urlPath&#34;</span> : <span style=color:#e6db74>&#34;/image.jpg&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>B接收的內容如下:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;avatar&#34;</span>:<span style=color:#e6db74>&#34;/default.jpg&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;fromUserName&#34;</span>:<span style=color:#e6db74>&#34;A&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;fromUUID&#34;</span> : <span style=color:#e6db74>&#34;123&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;toUUID&#34;</span> : <span style=color:#e6db74>&#34;321&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;contentType&#34;</span>:<span style=color:#ae81ff>1</span>, <span style=color:#75715e>//1 為image,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#ae81ff>4</span>, <span style=color:#75715e>//4 為訊息
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>&#34;messageType&#34;</span> : <span style=color:#ae81ff>1</span>, <span style=color:#75715e>//1為單人聊天
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>&#34;urlPath&#34;</span> : <span style=color:#e6db74>&#34;/image.jpg&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>因為知道<code>contentType</code>是<code>2</code>,所以知道是圖片類型，也知道<code>urlPath</code>保存了圖片的URL。</p><hr><p>以上都是單聊的情況，那群聊呢？群聊就跟單聊有些不一樣了呢😂<br>因為群聊是的接收對象會是群組的UUID,如果不處理一下的話，哪發送者會是發送訊息的人，在Client-side做處理的時候會出錯(因為發送者是A，不是群，哈哈哈)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span>群組訊息發送思路：
</span></span><span style=display:flex><span>發送者 : A -&gt; Group // A 發送訊息到群組
</span></span><span style=display:flex><span>接收者 : B &lt;- Group // B 接收來自群組的訊息
</span></span></code></pre></div><p><strong>A為發送者(UUID:123)，B為接收者(UUID:321), 群組G(UUID:G123)</strong>。</p><h5 id=情境一發送文字-1>情境一：發送文字。
<a class=header-anchor href=#%e6%83%85%e5%a2%83%e4%b8%80%e7%99%bc%e9%80%81%e6%96%87%e5%ad%97-1></a></h5><p>A 發送<code>Hello!</code>給到群組G，以下是發送內容：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;avatar&#34;</span>:<span style=color:#e6db74>&#34;/default.jpg&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;fromUserName&#34;</span>:<span style=color:#e6db74>&#34;A&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;fromUUID&#34;</span> : <span style=color:#e6db74>&#34;123&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;toUUID&#34;</span> : <span style=color:#e6db74>&#34;G123&#34;</span>, <span style=color:#75715e>//發送給群組UUID為G123的群組
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>&#34;content&#34;</span> : <span style=color:#e6db74>&#34;Hello!&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;contentType&#34;</span>:<span style=color:#ae81ff>1</span>, <span style=color:#75715e>//1 為text,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#ae81ff>4</span>, <span style=color:#75715e>//4 為訊息
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>&#34;messageType&#34;</span> : <span style=color:#ae81ff>2</span>, <span style=color:#75715e>//2為群組聊天
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>&#34;groupName&#34;</span>:<span style=color:#e6db74>&#34;groupName#1&#34;</span>, <span style=color:#75715e>//UUID：G123 群名字
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>&#34;groupAvatar&#34;</span>:<span style=color:#e6db74>&#34;/defaultGroup.jpg&#34;</span>, <span style=color:#75715e>//UUID：G123 群頭像URL
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>B接收的內容如下:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;avatar&#34;</span>:<span style=color:#e6db74>&#34;/default.jpg&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;fromUserName&#34;</span>:<span style=color:#e6db74>&#34;A&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;fromUUID&#34;</span> : <span style=color:#e6db74>&#34;G123&#34;</span>, <span style=color:#75715e>// 群組UUID為G123的發送訊息
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>&#34;toUUID&#34;</span> : <span style=color:#e6db74>&#34;321&#34;</span>, <span style=color:#75715e>//接收者UUID為321
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>&#34;content&#34;</span> : <span style=color:#e6db74>&#34;Hello!&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;contentType&#34;</span>:<span style=color:#ae81ff>1</span>, <span style=color:#75715e>//1 為text,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#ae81ff>4</span>, <span style=color:#75715e>//4 為訊息
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>&#34;messageType&#34;</span> : <span style=color:#ae81ff>2</span>, <span style=color:#75715e>//2為單人聊天
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>&#34;groupName&#34;</span>:<span style=color:#e6db74>&#34;groupName#1&#34;</span>, <span style=color:#75715e>//UUID：G123 群名字
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>&#34;groupAvatar&#34;</span>:<span style=color:#e6db74>&#34;/defaultGroup.jpg&#34;</span>, <span style=color:#75715e>//UUID：G123 群頭像URL
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><hr><h5 id=情境二發送圖片-1>情境二：發送圖片。
<a class=header-anchor href=#%e6%83%85%e5%a2%83%e4%ba%8c%e7%99%bc%e9%80%81%e5%9c%96%e7%89%87-1></a></h5><p>在透過websocket發送內容之前，會先透過API上傳圖片到Server，然後Server會回傳圖片的URL。然後再發送該URL即可。<br>假設Server回傳的URL如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;code&#34;</span>:<span style=color:#ae81ff>200</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;path&#34;</span>:<span style=color:#e6db74>&#34;/image.jpg&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>A 發送圖片給B，以下是發送內容：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;avatar&#34;</span>:<span style=color:#e6db74>&#34;/default.jpg&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;fromUserName&#34;</span>:<span style=color:#e6db74>&#34;A&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;fromUUID&#34;</span> : <span style=color:#e6db74>&#34;123&#34;</span>, <span style=color:#75715e>//發送者UUID
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>&#34;toUUID&#34;</span> : <span style=color:#e6db74>&#34;G123&#34;</span>, <span style=color:#75715e>//群組UUID
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>&#34;contentType&#34;</span>:<span style=color:#ae81ff>2</span>, <span style=color:#75715e>//2 為image,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#ae81ff>4</span>, <span style=color:#75715e>//4 為訊息
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>&#34;messageType&#34;</span> : <span style=color:#ae81ff>1</span>, <span style=color:#75715e>//2為群組聊天
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>&#34;urlPath&#34;</span> : <span style=color:#e6db74>&#34;/image.jpg&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;groupName&#34;</span>:<span style=color:#e6db74>&#34;groupName#1&#34;</span>, <span style=color:#75715e>//UUID：G123 群名字
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>&#34;groupAvatar&#34;</span>:<span style=color:#e6db74>&#34;/defaultGroup.jpg&#34;</span>, <span style=color:#75715e>//UUID：G123 群頭像URL
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>B接收的內容如下:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;avatar&#34;</span>:<span style=color:#e6db74>&#34;/default.jpg&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;fromUserName&#34;</span>:<span style=color:#e6db74>&#34;A&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;fromUUID&#34;</span> : <span style=color:#e6db74>&#34;G123&#34;</span>, <span style=color:#75715e>//群組UUID
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>&#34;toUUID&#34;</span> : <span style=color:#e6db74>&#34;321&#34;</span>, <span style=color:#75715e>//接收者UUID
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>&#34;contentType&#34;</span>:<span style=color:#ae81ff>2</span>, <span style=color:#75715e>//2 為image,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#ae81ff>4</span>, <span style=color:#75715e>//4 為訊息
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>&#34;messageType&#34;</span> : <span style=color:#ae81ff>1</span>, <span style=color:#75715e>//2為群組聊天
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>&#34;urlPath&#34;</span> : <span style=color:#e6db74>&#34;/image.jpg&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;groupName&#34;</span>:<span style=color:#e6db74>&#34;groupName#1&#34;</span>, <span style=color:#75715e>//UUID：G123 群名字
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>&#34;groupAvatar&#34;</span>:<span style=color:#e6db74>&#34;/defaultGroup.jpg&#34;</span>, <span style=color:#75715e>//UUID：G123 群頭像URL
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>以上便是在個人聊天和群組聊天中透過自定義資料結構的基本用法，雖然只說明了2種用法,分別是文本和圖片，但對於其他類型也是一樣的，只是資料不一樣而已罷了！😁</p><h4 id=你有可能會問欸如果在通訊的過程中用戶沒有在線或者沒有連接上server哪訊息不就消息了嗎哪用戶不就收不到訊息了>你有可能會問：欸，如果在通訊的過程中，用戶沒有在線或者沒有連接上server，哪訊息不就消息了嗎？哪用戶不就收不到訊息了？
<a class=header-anchor href=#%e4%bd%a0%e6%9c%89%e5%8f%af%e8%83%bd%e6%9c%83%e5%95%8f%e6%ac%b8%e5%a6%82%e6%9e%9c%e5%9c%a8%e9%80%9a%e8%a8%8a%e7%9a%84%e9%81%8e%e7%a8%8b%e4%b8%ad%e7%94%a8%e6%88%b6%e6%b2%92%e6%9c%89%e5%9c%a8%e7%b7%9a%e6%88%96%e8%80%85%e6%b2%92%e6%9c%89%e9%80%a3%e6%8e%a5%e4%b8%8aserver%e5%93%aa%e8%a8%8a%e6%81%af%e4%b8%8d%e5%b0%b1%e6%b6%88%e6%81%af%e4%ba%86%e5%97%8e%e5%93%aa%e7%94%a8%e6%88%b6%e4%b8%8d%e5%b0%b1%e6%94%b6%e4%b8%8d%e5%88%b0%e8%a8%8a%e6%81%af%e4%ba%86></a></h4><p>這個問題問的好，對於這個問題我也google很久解決方案。最後找到了解決方案，也就是將離線的消息，也就是用戶接收不到的消息用一個Container保存起來。當用戶上線時，或者重新連接到server時，就將這個消息發送
給他就好了(傳輸過程中丟失的問題，暫時不考慮蛤🤣)！這樣用戶就能在離線的情況下也能收到發送給他們的消息了！<br>而在這個APP裡面我是透過Redis來實現的。因為我們的消息一但發送給用戶就會馬上刪除掉了，如果用SQL的話，就頻繁的做IO，影響效能。所以這裡就使用Redis來幫我實現。而是用來Hash的數據類型來保每個用戶的離線消息！</p><blockquote><p>獲取用戶離線消息</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#a6e22e>len</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>variable</span>.<span style=color:#a6e22e>RedisConnection</span>.<span style=color:#a6e22e>LLen</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>Uuid</span>).<span style=color:#a6e22e>Result</span>()
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>logx</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#e6db74>&#34;getting Redis length err &#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>messages</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>svcCtx</span>.<span style=color:#a6e22e>RedisClient</span>.<span style=color:#a6e22e>LRange</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>u</span>.<span style=color:#a6e22e>Uuid</span>, <span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>len</span>).<span style=color:#a6e22e>Result</span>()
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>w</span>.<span style=color:#a6e22e>WriteHeader</span>(<span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>StatusBadRequest</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>logx</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;get offline messages error %s &#34;</span>, <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>())
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><blockquote><p>新增用戶離線消息</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-golang data-lang=golang><span style=display:flex><span><span style=color:#a6e22e>ctx</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>Background</span>()
</span></span><span style=display:flex><span><span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>variable</span>.<span style=color:#a6e22e>RedisConnection</span>.<span style=color:#a6e22e>RPush</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>mem</span>.<span style=color:#a6e22e>MemberInfo</span>.<span style=color:#a6e22e>Uuid</span>, <span style=color:#a6e22e>messageBytes</span>).<span style=color:#a6e22e>Result</span>()
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>logx</span>.<span style=color:#a6e22e>Error</span>(<span style=color:#e6db74>&#34;offline message to redis err %s&#34;</span>, <span style=color:#a6e22e>err</span>.<span style=color:#a6e22e>Error</span>())
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>而每條離線消息就只是把傳輸的Message 序列化成String而已，也就是每條離線消息都是String。當獲取的時候只要反序列化就可以繼續傳送了，非常的方便！</p><h3 id=最終demo>最終Demo
<a class=header-anchor href=#%e6%9c%80%e7%b5%82demo></a></h3><p><video src=/videos/chat-app/chat-app-final.mp4 controls width=500></video></p><h3 id=source-code>Source Code
<a class=header-anchor href=#source-code></a></h3><p><a href=https://github.com/RyanTokManMokMTM/swiftui-chat-app title=Frontend rel="noopener external nofollow noreferrer" target=_blank class=exturl>Frontend
<i class="fa fa-external-link-alt"></i>
</a><a href=https://github.com/RyanTokManMokMTM/chat-app-server title=Backend rel="noopener external nofollow noreferrer" target=_blank class=exturl>Backend
<i class="fa fa-external-link-alt"></i></a></p></div><footer class=post-footer><div class=post-tags><a href=/tags/chat-app>chat-app</a></div><div class=addthis_inline_share_toolbox style=text-align:center></div><hr><div class=post-copyright><img src=/imgs/cc/cc.svg width=75 height=75 align=right alt=共享知識><ul><li class=post-copyright-title><strong>文章標題：</strong>
[開發者日記] 聊天通訊APP(四) - 最終章</li><li class=post-copyright-author><strong>本文作者： </strong>Jackson.tmm</li><li class=post-copyright-link><strong>本文鏈接：</strong>
<a id=post-cr-link href=http://localhost:1313/post/project/chat-app-final/ title="[開發者日記] 聊天通訊APP(四) - 最終章">http://localhost:1313/post/project/chat-app-final/</a></li><li class=post-copyright-license><strong>版權聲明： </strong>本博客所有文章除特別聲明外，均採用 <i class="fab fa-fw fa-creative-commons"></i><a target=_blank href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh>BY-NC-SA</a> 許可協議。轉載請註明出處！</li></ul></div><div class=followme><span>歡迎關注我的其它發布渠道</span><div class=social-list><div class=social-item><a target=_blank class=social-link href=https://www.instagram.com/tm_m.0418/><span class=icon><i class="fab fa-instagram"></i>
</span><span class=label>Instagram</span></a></div><div class=social-item><a target=_blank class=social-link href=https://www.linkedin.com/in/jackson-moktokman><span class=icon><i class="fab fa-linkedin"></i>
</span><span class=label>LinkedIn</span></a></div></div></div><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/post/project/chat-app-voice-chat/ rel=next title="[開發者日記] 聊天通訊APP - RTC小更新"><i class="fa fa-chevron-left"></i> [開發者日記] 聊天通訊APP - RTC小更新</a></div><div class="post-nav-prev post-nav-item"><a href=/post/project/chat-app-update/ rel=prev title="[開發者日記] 聊天通訊APP(三) - 聊天小更新">[開發者日記] 聊天通訊APP(三) - 聊天小更新
<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div id=comments class=post-comments><div class=comment-head><div class=comment-headline><i class="fas fa-comments fa-fw"></i>
<span></span></div></div><div class=comment-wrap><div><div class=comment-loading><i class="fa fa-sync fa-spin"></i></div><div class=utterances-container></div></div></div></div></div></main><footer class=footer><div class=footer-inner><div class=copyright>&copy;
<span itemprop=copyrightYear>2022 - 2024
</span><span class=with-love><i class="fa fa-heart"></i>
</span><span class=author itemprop=copyrightHolder>Jackson.tmm</span></div><div class=vendors-list><a target=_blank href=https://github.com title=Github><img src=/imgs/img-lazy-loading.gif data-src=/imgs/vendors/github.svg alt=Github>
</a><span>提供CDN/雲資源支持</span></div><script type=text/javascript src=https://cdn.jsdelivr.net/npm/live2d-widget@3.1.4/lib/L2Dwidget.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/live2d-widget@3.1.4/lib/L2Dwidget.0.min.js></script><div class="pio-container left"><div class=pio-action></div><canvas id=pio width=300 height=500></canvas></div></div><div class=elfsight-app-b04b61d3-ff26-4d9d-a289-163c1b59bd32 data-elfsight-app-lazy></div></div></footer><script type=text/javascript src=http://localhost:1313/3rd/animejs/3.2.2/anime.min.js crossorigin=anonymous defer></script><script type=text/javascript src=http://localhost:1313/3rd/viewerjs/1.11.6/viewer.min.js crossorigin=anonymous defer></script><script class=next-config data-name=main type=application/json>{"bookmark":{"color":"#333","enable":true,"save":"manual"},"copybtn":true,"darkmode":true,"giscus":{"cfg":{"category":"Comments","categoryid":null,"emit":false,"inputposition":"top","mapping":"title","reactions":false,"repo":"username/repo-name","repoid":null,"theme":"preferred_color_scheme"},"js":"https://giscus.app/client.js"},"hostname":"http://localhost:1313/","i18n":{"ds_day":" 天前","ds_days":" 天 ","ds_hour":" 小時前","ds_hours":" 小時 ","ds_just":"剛剛","ds_min":" 分鐘前","ds_mins":" 分鐘","ds_month":" 個月前","ds_years":" 年 ","empty":"沒有找到任何搜索結果：${query}","hits":"找到 ${hits} 個搜索結果","hits_time":"找到 ${hits} 個搜索結果（用時 ${time} 毫秒）","placeholder":"搜索..."},"lang":"zh-TW","lawidget":{"id":"JiZkaipzkPyiCL8x","js":"https://v6-widget.51.la/v6/laId/quote.js?theme=0\u0026col=true\u0026f=12\u0026display=0,0,0,1,0,1,1,1"},"lazyload":false,"localSearch":{"enable":true,"limit":1e3,"path":"/searchindexes.xml","preload":false,"topnperarticle":-1,"trigger":"auto","unescape":false},"motion":{"async":true,"enable":true,"transition":{"collheader":"fadeInLeft","postblock":"fadeIn","postbody":"fadeInDown","postheader":"fadeInDown","sidebar":"fadeInUp"}},"postmeta":{"comments":{"enable":false,"plugin":"waline"},"views":{"enable":true,"plugin":"busuanzi"}},"root":"/","scheme":"Gemini","sidebar":{"display":"post","offset":12,"padding":18,"position":"left","width":256},"utterances":{"cfg":{"issueterm":"pathname","label":"comments","repo":"RyanTokManMokMTM/RyanTokManMokMTM.github.io","theme":"github-light"},"js":"https://utteranc.es/client.js"},"vendor":{"plugins":"local","router":{"name":"local","type":"modern","url":"http://localhost:1313/3rd"}},"version":"4.6.3","waline":{"cfg":{"emoji":false,"imguploader":false,"placeholder":"请文明发言哟 ヾ(≧▽≦*)o \n\n可用快捷键选取表情符号：😀😄😁🥳👻👽👀🚄\n(Window系统：Win+.，Mac系统：Control+Command+Space)","reaction":true,"reactiontext":["点赞","踩一下","得意","不屑","尴尬","睡觉"],"reactiontitle":"你认为这篇文章怎么样？","requiredmeta":["nick","mail"],"serverurl":"https://walinejs.comment.lithub.cc","sofa":"快来发表你的意见吧 (≧∀≦)ゞ","wordlimit":200},"css":{"alias":"@waline/client","file":"dist/waline.css","name":"waline","version":"2.15.8"},"js":{"alias":"@waline/client","file":"dist/waline.js","name":"waline","version":"2.15.8"}}}</script><script type=text/javascript src=/js/main.js defer></script><script src=https://static.elfsight.com/platform/platform.js data-use-service-core defer></script><script src=/js/l2d.js></script><script src=/js/pio.js></script><script>var pio=new Paul_Pio({mode:"draggable",hidden:!0,content:{welcome:["歡迎來到Jackson的小宇宙！","今天天氣不錯，一起来玩吧！","博主有空的話，會寫一寫博客記錄一下!"],custom:[{selector:".home-social a:last-child",text:"在這里可以了解博主的日常噢~"},{selector:".post-item a",type:"read"},{selector:".post-content a, .page-content a",type:"link"}]},model:["/model/umaru/model.json","/model/tororo/tororo.model.json","/model/HN/nepmaid/model.json","/model/HN/nepgearswim/model.json","/model/HN/neptune_santa/model.json","/model/other/rem/model.json","/model/other/mei/model.json","/model/other/liang/2.json","/model/HN/noir_santa/model.json","/model/HN/noireswim/model.json","/model/other/blanc_normal/index.json","/model/other/88type_1809/normal/model.json","/model/other/88type_1809/destroy/model.json","/model/other/dsr50_1801/normal/model.json","/model/other/dsr50_1801/destroy/model.json","/model/other/g36c_1202/normal/model.json","/model/other/g36c_1202/destroy/model.json","/model/other/kp31_310/normal/model.json","/model/other/kp31_310/destroy/model.json","/model/other/kp31_1103/normal/model.json","/model/other/kp31_1103/destroy/model.json"],touch:["不可以這樣欺負我啦><"]})</script></body></html>